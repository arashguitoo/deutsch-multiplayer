<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Wer √ºberlebt? - Live Battle</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            min-height: 100vh;
            color: white;
        }
        
        .container { max-width: 900px; margin: 0 auto; padding: 15px; }
        
        h1 {
            text-align: center;
            font-size: 1.5em;
            margin-bottom: 15px;
            text-shadow: 0 0 20px rgba(255,215,0,0.5);
        }
        
        /* Login Screen */
        #login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 85vh;
            gap: 15px;
        }
        
        .logo { font-size: 4em; animation: pulse 2s infinite; }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        #login-screen h2 { font-size: 1.2em; color: #ffd700; text-align: center; }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            max-width: 300px;
        }
        
        .input-group input {
            font-size: 1.1em;
            padding: 12px 20px;
            border: 2px solid #ffd700;
            border-radius: 25px;
            text-align: center;
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .input-group input::placeholder { color: rgba(255,255,255,0.5); }
        
        .input-group input.code-input {
            font-size: 1.5em;
            letter-spacing: 8px;
            text-transform: uppercase;
        }
        
        .btn-primary {
            font-size: 1.1em;
            padding: 15px 40px;
            border: none;
            border-radius: 30px;
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
            max-width: 300px;
        }
        
        .btn-primary:hover { transform: scale(1.03); }
        
        .btn-secondary {
            font-size: 1em;
            padding: 12px 30px;
            border: 2px solid #ffd700;
            border-radius: 25px;
            background: transparent;
            color: #ffd700;
            cursor: pointer;
            width: 100%;
            max-width: 300px;
        }
        
        .btn-secondary:hover { background: rgba(255,215,0,0.1); }
        
        .divider {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
            max-width: 300px;
            margin: 10px 0;
        }
        
        .divider::before, .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(255,255,255,0.3);
        }
        
        .divider span { color: #888; font-size: 0.9em; }
        
        /* Host Create Screen */
        #host-create-screen { display: none; }
        
        .code-display {
            font-size: 3em;
            letter-spacing: 15px;
            color: #ffd700;
            background: rgba(255,215,0,0.1);
            padding: 20px 40px;
            border-radius: 15px;
            border: 2px solid rgba(255,215,0,0.5);
            margin: 20px 0;
        }
        
        /* Lobby */
        #lobby-screen { display: none; text-align: center; }
        
        .lobby-box {
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
        }
        
        .lobby-code {
            font-size: 1.5em;
            color: #ffd700;
            letter-spacing: 5px;
            margin-bottom: 10px;
        }
        
        .waiting-players {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
            min-height: 50px;
        }
        
        .waiting-player {
            padding: 10px 15px;
            background: rgba(255,215,0,0.2);
            border-radius: 20px;
            border: 1px solid rgba(255,215,0,0.5);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95em;
        }
        
        .waiting-player .remove-btn {
            background: rgba(255,0,0,0.4);
            border: none;
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 11px;
            line-height: 22px;
        }
        
        .waiting-player .remove-btn:hover { background: rgba(255,0,0,0.7); }
        
        .start-game-btn {
            font-size: 1.2em;
            padding: 15px 50px;
            border: none;
            border-radius: 30px;
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin: 15px 0;
        }
        
        .start-game-btn:hover { transform: scale(1.03); }
        .start-game-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .host-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .small-btn {
            font-size: 0.85em;
            padding: 8px 15px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 15px;
            background: transparent;
            color: #aaa;
            cursor: pointer;
        }
        
        .small-btn:hover { background: rgba(255,255,255,0.1); }
        .small-btn.danger { border-color: #e74c3c; color: #e74c3c; }
        
        /* Game Screen */
        #game-screen { display: none; }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .player-info { display: flex; align-items: center; gap: 10px; }
        .player-name { font-weight: bold; color: #ffd700; font-size: 0.95em; }
        .lives { font-size: 1.3em; letter-spacing: 2px; }
        
        .timer-box { text-align: center; }
        
        .timer {
            font-size: 2.2em;
            font-weight: bold;
            color: #00cec9;
            text-shadow: 0 0 20px rgba(0,206,201,0.5);
            min-width: 60px;
        }
        
        .timer.warning { color: #fdcb6e; }
        .timer.danger { color: #e74c3c; animation: timerPulse 0.5s infinite; }
        
        @keyframes timerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }
        
        .progress-info { text-align: right; }
        .question-num { font-size: 1em; color: #ffd700; }
        .survivors { font-size: 0.85em; color: #00cec9; }
        
        /* Quiz Section */
        .quiz-section {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,215,0,0.3);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .category-badge {
            display: inline-block;
            padding: 5px 15px;
            background: rgba(255,215,0,0.2);
            border-radius: 20px;
            font-size: 0.85em;
            color: #ffd700;
            margin-bottom: 12px;
        }
        
        .question { font-size: 1.25em; margin-bottom: 20px; line-height: 1.4; }
        
        .answers { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        @media (max-width: 600px) { .answers { grid-template-columns: 1fr; } }
        
        .answer-btn {
            padding: 14px 16px;
            font-size: 1em;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            background: rgba(255,255,255,0.05);
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }
        
        .answer-btn:hover:not(:disabled):not(.selected) {
            background: rgba(255,215,0,0.2);
            border-color: #ffd700;
        }
        
        .answer-btn.selected {
            background: rgba(100,100,255,0.3);
            border-color: #6c5ce7;
        }
        
        .answer-btn.correct {
            background: rgba(0,184,148,0.5);
            border-color: #00b894;
        }
        
        .answer-btn.wrong {
            background: rgba(214,48,49,0.5);
            border-color: #d63031;
        }
        
        .answer-btn:disabled { cursor: not-allowed; opacity: 0.8; }
        
        .answer-btn .letter {
            display: inline-block;
            width: 26px;
            height: 26px;
            line-height: 26px;
            text-align: center;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            margin-right: 10px;
            font-weight: bold;
            font-size: 0.85em;
        }
        
        .answer-status {
            text-align: center;
            padding: 12px;
            margin-top: 15px;
            border-radius: 10px;
            font-weight: bold;
            display: none;
        }
        
        .answer-status.show { display: block; }
        .answer-status.waiting { background: rgba(108,92,231,0.3); color: #a29bfe; }
        .answer-status.correct { background: rgba(0,184,148,0.3); color: #55efc4; }
        .answer-status.wrong { background: rgba(214,48,49,0.3); color: #ff7675; }
        .answer-status.timeout { background: rgba(253,203,110,0.3); color: #fdcb6e; }
        
        /* Live Players */
        .live-players {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 12px;
        }
        
        .live-players h3 {
            font-size: 0.9em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .live-dot {
            width: 8px;
            height: 8px;
            background: #e74c3c;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .players-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .player-chip {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            font-size: 0.8em;
        }
        
        .player-chip.dead { opacity: 0.4; text-decoration: line-through; }
        .player-chip.is-me { border: 2px solid #ffd700; background: rgba(255,215,0,0.2); }
        
        /* Game Over */
        #gameover-screen { display: none; text-align: center; padding: 30px 20px; }
        #gameover-screen .result-icon { font-size: 4em; margin-bottom: 15px; }
        #gameover-screen h2 { font-size: 1.8em; margin-bottom: 10px; }
        #gameover-screen .result-message { font-size: 1.1em; color: #aaa; margin-bottom: 25px; }
        
        .final-stats {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: left;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .stat-row:last-child { border-bottom: none; }
        
        .winners-list {
            background: rgba(255,215,0,0.1);
            border: 2px solid rgba(255,215,0,0.3);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .winners-list h3 { color: #ffd700; margin-bottom: 12px; }
        
        .winner-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 6px;
        }
        
        /* Eliminated */
        #eliminated-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 200;
            flex-direction: column;
            gap: 15px;
        }
        
        #eliminated-overlay .skull { font-size: 5em; }
        #eliminated-overlay h2 { font-size: 1.8em; color: #d63031; }
        
        /* Connection */
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            background: rgba(0,0,0,0.5);
        }
        
        .connection-status.connected { color: #00b894; }
        .connection-status.disconnected { color: #e74c3c; }
        
        .error-msg {
            color: #e74c3c;
            font-size: 0.9em;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connection-status">Verbinde...</div>
    
    <div class="container">
        <h1>üéØ Wer √ºberlebt?</h1>
        
        <!-- Login Screen -->
        <div id="login-screen">
            <div class="logo">üéØ</div>
            <h2>50 Fragen ‚Ä¢ 3 Leben ‚Ä¢ 15 Sekunden</h2>
            
            <div class="input-group">
                <input type="text" id="player-name" placeholder="Dein Name" maxlength="15">
                <input type="text" id="game-code" class="code-input" placeholder="CODE" maxlength="4">
            </div>
            
            <button class="btn-primary" id="join-btn">üö™ Beitreten</button>
            
            <div class="divider"><span>oder</span></div>
            
            <button class="btn-secondary" id="create-btn">üëë Neues Spiel erstellen</button>
            
            <div class="error-msg" id="error-msg"></div>
        </div>
        
        <!-- Lobby Screen -->
        <div id="lobby-screen">
            <div class="lobby-box">
                <h2>‚è≥ Warteraum</h2>
                <div class="lobby-code" id="lobby-code">CODE</div>
                <p style="color: #888; font-size: 0.85em; margin-bottom: 15px;">Teile diesen Code mit deinen Sch√ºlern</p>
                
                <div class="waiting-players" id="waiting-players">
                    <p style="color: #666;">Warte auf Spieler...</p>
                </div>
                
                <div id="host-controls">
                    <button class="start-game-btn" id="start-game-btn" disabled>‚ñ∂Ô∏è SPIEL STARTEN</button>
                    <p style="color: #00b894; font-size: 0.85em;">üëë Du bist der Spielleiter</p>
                    
                    <div class="host-actions">
                        <button class="small-btn danger" id="clear-players-btn">üóëÔ∏è Alle entfernen</button>
                        <button class="small-btn danger" id="reset-game-btn">üîÑ Spiel zur√ºcksetzen</button>
                    </div>
                </div>
                
                <div id="player-controls" style="display: none;">
                    <p style="color: #fdcb6e; font-size: 1.1em;">‚è≥ Warte auf Spielleiter...</p>
                </div>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="game-screen">
            <div class="game-header">
                <div class="player-info">
                    <span class="player-name" id="display-name"></span>
                    <span class="lives" id="display-lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
                </div>
                <div class="timer-box">
                    <div class="timer" id="timer">15</div>
                </div>
                <div class="progress-info">
                    <div class="question-num" id="question-num">1/50</div>
                    <div class="survivors" id="survivors">üë• 0</div>
                </div>
            </div>
            
            <div class="quiz-section">
                <div class="category-badge" id="category"></div>
                <div class="question" id="question"></div>
                <div class="answers" id="answers"></div>
                <div class="answer-status" id="answer-status"></div>
            </div>
            
            <div class="live-players">
                <h3><span class="live-dot"></span> Spieler</h3>
                <div class="players-grid" id="players-grid"></div>
            </div>
        </div>
        
        <!-- Game Over -->
        <div id="gameover-screen">
            <div class="result-icon" id="result-icon">üèÜ</div>
            <h2 id="result-title">Spiel beendet!</h2>
            <p class="result-message" id="result-message"></p>
            
            <div class="final-stats">
                <div class="stat-row"><span>Richtig</span><span id="stat-correct">0</span></div>
                <div class="stat-row"><span>Falsch</span><span id="stat-wrong">0</span></div>
                <div class="stat-row"><span>Leben</span><span id="stat-lives">0</span></div>
            </div>
            
            <div class="winners-list">
                <h3>üèÜ √úberlebende</h3>
                <div id="winners-content"></div>
            </div>
            
            <button class="btn-primary" id="back-home-btn">üè† Zur√ºck zum Start</button>
        </div>
        
        <!-- Eliminated -->
        <div id="eliminated-overlay">
            <div class="skull">üíÄ</div>
            <h2>Ausgeschieden!</h2>
            <p style="color: #aaa;">Du kannst weiter zuschauen</p>
            <button class="btn-secondary" id="watch-btn">üëÄ Zuschauen</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        
        if (typeof firebase === 'undefined') {
            document.getElementById('error-msg').textContent = "Firebase konnte nicht geladen werden.";
            return;
        }
        
        firebase.initializeApp({
            apiKey: "AIzaSyBDChXlm34Kr7Gg0Dw458GiiwoLnWJAnxM",
            authDomain: "lern-deutsch-arash.firebaseapp.com",
            databaseURL: "https://lern-deutsch-arash-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "lern-deutsch-arash",
            storageBucket: "lern-deutsch-arash.firebasestorage.app",
            messagingSenderId: "845503292114",
            appId: "1:845503292114:web:f76ab5fcde1e978d00c30b"
        });
        
        const db = firebase.database();
        
        // 50 Fragen
        const questions = [
            { cat: "Reflexivverben", q: "Ich ___ mich jeden Morgen.", a: ["wasche", "waschst", "waschen", "w√§scht"], c: 0 },
            { cat: "Reflexivverben", q: "Er ___ sich auf die Pr√ºfung vor.", a: ["bereitet", "bereite", "bereitest", "bereiten"], c: 0 },
            { cat: "Reflexivverben", q: "Wir ___ uns √ºber das Geschenk.", a: ["freuen", "freut", "freue", "freust"], c: 0 },
            { cat: "Reflexivverben", q: "Du musst ___ beeilen!", a: ["dich", "sich", "mich", "uns"], c: 0 },
            { cat: "Reflexivverben", q: "Sie interessiert ___ f√ºr Musik.", a: ["sich", "mich", "dich", "uns"], c: 0 },
            { cat: "Reflexivverben", q: "Ich habe ___ erk√§ltet.", a: ["mich", "sich", "dich", "mir"], c: 0 },
            { cat: "Reflexivverben", q: "K√∂nnt ihr ___ das vorstellen?", a: ["euch", "sich", "uns", "mir"], c: 0 },
            { cat: "Reflexivverben", q: "Er hat ___ verletzt.", a: ["sich", "mich", "ihn", "ihm"], c: 0 },
            { cat: "Reflexivverben", q: "Wir treffen ___ um 8 Uhr.", a: ["uns", "euch", "sich", "mich"], c: 0 },
            { cat: "Reflexivverben", q: "Ich ziehe ___ schnell an.", a: ["mich", "mir", "sich", "dich"], c: 0 },
            { cat: "Reflexivverben", q: "Sie haben ___ gestritten.", a: ["sich", "uns", "euch", "ihnen"], c: 0 },
            { cat: "Reflexivverben", q: "Setzt ___ bitte hin!", a: ["euch", "sich", "uns", "dich"], c: 0 },
            { cat: "Verben + Pr√§p.", q: "Ich warte ___ den Bus.", a: ["auf", "f√ºr", "an", "√ºber"], c: 0 },
            { cat: "Verben + Pr√§p.", q: "Er denkt oft ___ seine Familie.", a: ["an", "auf", "√ºber", "f√ºr"], c: 0 },
            { cat: "Verben + Pr√§p.", q: "Sie freut sich ___ das Wochenende.", a: ["auf", "√ºber", "f√ºr", "an"], c: 0 },
            { cat: "Verben + Pr√§p.", q: "Wir sprechen ___ das Problem.", a: ["√ºber", "von", "auf", "f√ºr"], c: 0 },
            { cat: "Verben + Pr√§p.", q: "Ich interessiere mich ___ Sport.", a: ["f√ºr", "an", "auf", "√ºber"], c: 0 },
            { cat: "Verben + Pr√§p.", q: "Er bittet mich ___ Hilfe.", a: ["um", "f√ºr", "auf", "nach"], c: 0 },
            { cat: "Verben + Pr√§p.", q: "Sie √§rgert sich ___ den Fehler.", a: ["√ºber", "auf", "f√ºr", "an"], c: 0 },
            { cat: "Verben + Pr√§p.", q: "Ich tr√§ume ___ einem Urlaub.", a: ["von", "√ºber", "an", "auf"], c: 0 },
            { cat: "Verben + Pr√§p.", q: "Er k√ºmmert sich ___ die Kinder.", a: ["um", "f√ºr", "auf", "√ºber"], c: 0 },
            { cat: "Verben + Pr√§p.", q: "Wir haben ___ dem Chef gesprochen.", a: ["mit", "zu", "bei", "von"], c: 0 },
            { cat: "Verben + Pr√§p.", q: "Sie bedankt sich ___ das Geschenk.", a: ["f√ºr", "√ºber", "auf", "um"], c: 0 },
            { cat: "Verben + Pr√§p.", q: "Ich habe Angst ___ Spinnen.", a: ["vor", "von", "f√ºr", "√ºber"], c: 0 },
            { cat: "Verben + Pr√§p.", q: "Er verl√§sst sich ___ seine Freunde.", a: ["auf", "an", "f√ºr", "mit"], c: 0 },
            { cat: "Modalverben", q: "Ich ___ gestern nicht kommen.", a: ["konnte", "k√∂nnte", "kann", "gekonnt"], c: 0 },
            { cat: "Modalverben", q: "Er ___ fr√ºher aufstehen.", a: ["musste", "m√ºsste", "muss", "gemusst"], c: 0 },
            { cat: "Modalverben", q: "Sie ___ als Kind nicht schwimmen.", a: ["durfte", "d√ºrfte", "darf", "gedurft"], c: 0 },
            { cat: "Modalverben", q: "Wir ___ lange warten.", a: ["mussten", "m√ºssen", "m√ºssten", "gemusst"], c: 0 },
            { cat: "Modalverben", q: "Ich ___ das nicht verstehen.", a: ["konnte", "kann", "k√∂nnte", "gekonnt"], c: 0 },
            { cat: "Modalverben", q: "Er ___ immer Fu√üball spielen.", a: ["wollte", "will", "wollten", "gewollt"], c: 0 },
            { cat: "Modalverben", q: "Du ___ das nicht tun!", a: ["solltest", "sollst", "sollte", "gesollt"], c: 0 },
            { cat: "Modalverben", q: "Sie ___ nicht rauchen.", a: ["durften", "d√ºrfen", "d√ºrften", "gedurft"], c: 0 },
            { cat: "Modalverben", q: "Als Kind ___ ich kein Gem√ºse.", a: ["mochte", "mag", "m√∂chte", "gemocht"], c: 0 },
            { cat: "Modalverben", q: "Wir ___ fr√ºher viel reisen.", a: ["konnten", "k√∂nnen", "k√∂nnten", "gekonnt"], c: 0 },
            { cat: "Modalverben", q: "Er ___ den Brief schreiben.", a: ["sollte", "soll", "sollten", "gesollt"], c: 0 },
            { cat: "Modalverben", q: "Sie ___ unbedingt den Film sehen.", a: ["wollte", "will", "wollten", "gewollt"], c: 0 },
            { cat: "Modalverben", q: "Ich ___ leider nicht helfen.", a: ["konnte", "kann", "k√∂nnte", "gekonnt"], c: 0 },
            { cat: "Akk./Dativ", q: "Ich schenke ___ ein Buch.", a: ["dir", "dich", "du", "deiner"], c: 0 },
            { cat: "Akk./Dativ", q: "Er gibt ___ das Geld.", a: ["mir", "mich", "ich", "meiner"], c: 0 },
            { cat: "Akk./Dativ", q: "Sie zeigt ___ die Fotos.", a: ["uns", "wir", "unser", "unsere"], c: 0 },
            { cat: "Akk./Dativ", q: "Ich kaufe ___ Mutter Blumen.", a: ["meiner", "meine", "meinem", "meinen"], c: 0 },
            { cat: "Akk./Dativ", q: "Kannst du ___ das erkl√§ren?", a: ["mir", "mich", "ich", "meiner"], c: 0 },
            { cat: "Akk./Dativ", q: "Er bringt ___ einen Kaffee.", a: ["ihr", "sie", "ihren", "ihre"], c: 0 },
            { cat: "Akk./Dativ", q: "Ich schicke ___ eine Nachricht.", a: ["ihm", "ihn", "er", "seiner"], c: 0 },
            { cat: "Akk./Dativ", q: "Sie leiht ___ das Auto.", a: ["ihm", "ihn", "er", "sein"], c: 0 },
            { cat: "Akk./Dativ", q: "Gib ___ bitte den Stift!", a: ["mir", "mich", "ich", "meinen"], c: 0 },
            { cat: "Akk./Dativ", q: "Er hat ___ geholfen.", a: ["mir", "mich", "ich", "meiner"], c: 0 },
            { cat: "Akk./Dativ", q: "Ich bringe ___ den Kuchen.", a: ["euch", "ihr", "euer", "eure"], c: 0 },
            { cat: "Akk./Dativ", q: "Sie hat ___ das Buch empfohlen.", a: ["uns", "wir", "unser", "unsere"], c: 0 }
        ];
        
        // State
        let gameCode = null;
        let playerId = null;
        let playerName = null;
        let isHost = false;
        let lives = 3;
        let correct = 0;
        let wrong = 0;
        let currentQ = -1;
        let answered = false;
        let selected = null;
        let timer = null;
        let watching = false;
        let gameRef = null;
        let playersRef = null;
        
        // Connection
        db.ref(".info/connected").on("value", snap => {
            const el = document.getElementById("connection-status");
            el.textContent = snap.val() ? "üü¢ Online" : "üî¥ Offline";
            el.className = "connection-status " + (snap.val() ? "connected" : "disconnected");
        });
        
        // Generate 4-letter code
        function generateCode() {
            const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
            let code = "";
            for (let i = 0; i < 4; i++) code += chars[Math.floor(Math.random() * chars.length)];
            return code;
        }
        
        // Event listeners
        document.getElementById("create-btn").addEventListener("click", createGame);
        document.getElementById("join-btn").addEventListener("click", joinGame);
        document.getElementById("start-game-btn").addEventListener("click", startGame);
        document.getElementById("clear-players-btn").addEventListener("click", clearPlayers);
        document.getElementById("reset-game-btn").addEventListener("click", resetGame);
        document.getElementById("back-home-btn").addEventListener("click", backToHome);
        document.getElementById("watch-btn").addEventListener("click", () => {
            watching = true;
            document.getElementById("eliminated-overlay").style.display = "none";
        });
        
        document.getElementById("game-code").addEventListener("keypress", e => {
            if (e.key === "Enter") joinGame();
        });
        
        // Create new game as host
        function createGame() {
            playerName = document.getElementById("player-name").value.trim();
            if (!playerName) {
                showError("Bitte Name eingeben!");
                return;
            }
            
            gameCode = generateCode();
            playerId = "host_" + Date.now();
            isHost = true;
            
            gameRef = db.ref("battles/" + gameCode);
            playersRef = db.ref("battles/" + gameCode + "/players");
            
            // Altes Spiel l√∂schen und neu erstellen
            gameRef.remove().then(() => {
                return gameRef.set({
                    status: "lobby",
                    currentQuestion: -1,
                    questionStart: null,
                    host: playerId,
                    created: Date.now()
                });
            }).then(() => {
                return playersRef.child(playerId).set({
                    name: playerName,
                    lives: 3,
                    isHost: true
                });
            }).then(() => {
                playersRef.child(playerId).onDisconnect().remove();
                showLobby();
                setupListeners();
            }).catch(err => {
                showError("Fehler: " + err.message);
            });
        }
        
        // Join existing game
        function joinGame() {
            playerName = document.getElementById("player-name").value.trim();
            gameCode = document.getElementById("game-code").value.trim().toUpperCase();
            
            if (!playerName) {
                showError("Bitte Name eingeben!");
                return;
            }
            if (!gameCode || gameCode.length !== 4) {
                showError("Bitte 4-stelligen Code eingeben!");
                return;
            }
            
            playerId = "p_" + Date.now() + "_" + Math.random().toString(36).substr(2,4);
            isHost = false;
            
            gameRef = db.ref("battles/" + gameCode);
            playersRef = db.ref("battles/" + gameCode + "/players");
            
            // Check if game exists
            gameRef.once("value").then(snap => {
                if (!snap.exists()) {
                    showError("Spiel nicht gefunden!");
                    return;
                }
                
                const game = snap.val();
                if (game.status !== "lobby") {
                    showError("Spiel l√§uft bereits!");
                    return;
                }
                
                // Join
                return playersRef.child(playerId).set({
                    name: playerName,
                    lives: 3,
                    isHost: false
                });
            }).then(() => {
                if (!playerId) return;
                playersRef.child(playerId).onDisconnect().remove();
                showLobby();
                setupListeners();
            }).catch(err => {
                showError("Fehler: " + err.message);
            });
        }
        
        function showError(msg) {
            document.getElementById("error-msg").textContent = msg;
            setTimeout(() => document.getElementById("error-msg").textContent = "", 3000);
        }
        
        function showLobby() {
            document.getElementById("login-screen").style.display = "none";
            document.getElementById("lobby-screen").style.display = "block";
            document.getElementById("lobby-code").textContent = gameCode;
            
            if (isHost) {
                document.getElementById("host-controls").style.display = "block";
                document.getElementById("player-controls").style.display = "none";
            } else {
                document.getElementById("host-controls").style.display = "none";
                document.getElementById("player-controls").style.display = "block";
            }
        }
        
        function setupListeners() {
            // Players
            playersRef.on("value", snap => {
                const players = [];
                snap.forEach(child => {
                    const d = child.val();
                    if (d && d.name) {
                        players.push({ id: child.key, ...d });
                    }
                });
                updatePlayers(players);
            });
            
            // Game state
            gameRef.on("value", snap => {
                const game = snap.val();
                if (!game) {
                    // Game deleted
                    backToHome();
                    return;
                }
                
                if (game.status === "playing") {
                    document.getElementById("lobby-screen").style.display = "none";
                    document.getElementById("game-screen").style.display = "block";
                    
                    if (game.currentQuestion !== currentQ) {
                        currentQ = game.currentQuestion;
                        showQuestion(game.questionStart);
                    }
                } else if (game.status === "finished") {
                    endGame();
                }
            });
        }
        
        function updatePlayers(players) {
            // Lobby
            const waitingEl = document.getElementById("waiting-players");
            if (players.length === 0) {
                waitingEl.innerHTML = '<p style="color:#666">Warte auf Spieler...</p>';
            } else {
                waitingEl.innerHTML = players.map(p => `
                    <div class="waiting-player">
                        <span>${p.name} ${p.isHost ? 'üëë' : ''}</span>
                        ${isHost && !p.isHost ? `<button class="remove-btn" data-id="${p.id}">‚úï</button>` : ''}
                    </div>
                `).join("");
                
                // Add remove handlers
                waitingEl.querySelectorAll(".remove-btn").forEach(btn => {
                    btn.addEventListener("click", () => {
                        playersRef.child(btn.dataset.id).remove();
                    });
                });
            }
            
            // Enable start button
            const nonHostPlayers = players.filter(p => !p.isHost);
            document.getElementById("start-game-btn").disabled = nonHostPlayers.length === 0;
            
            // Game screen
            const grid = document.getElementById("players-grid");
            const alive = players.filter(p => p.lives > 0);
            document.getElementById("survivors").textContent = `üë• ${alive.length}`;
            
            grid.innerHTML = players.map(p => `
                <div class="player-chip ${p.lives === 0 ? 'dead' : ''} ${p.id === playerId ? 'is-me' : ''}">
                    <span>${p.name}</span>
                    <span>${p.lives > 0 ? '‚ù§Ô∏è'.repeat(p.lives) : 'üíÄ'}</span>
                </div>
            `).join("");
        }
        
        function clearPlayers() {
            if (!isHost) return;
            if (!confirm("Alle Spieler entfernen (au√üer dir)?")) return;
            
            playersRef.once("value", snap => {
                snap.forEach(child => {
                    if (child.key !== playerId) {
                        playersRef.child(child.key).remove();
                    }
                });
            });
        }
        
        function resetGame() {
            if (!isHost) return;
            if (!confirm("Spiel komplett zur√ºcksetzen?")) return;
            
            gameRef.update({
                status: "lobby",
                currentQuestion: -1,
                questionStart: null
            });
            
            // Reset all players lives
            playersRef.once("value", snap => {
                snap.forEach(child => {
                    playersRef.child(child.key).update({ lives: 3 });
                });
            });
            
            // Reset local state
            lives = 3;
            correct = 0;
            wrong = 0;
            currentQ = -1;
            watching = false;
            
            document.getElementById("game-screen").style.display = "none";
            document.getElementById("gameover-screen").style.display = "none";
            document.getElementById("eliminated-overlay").style.display = "none";
            document.getElementById("lobby-screen").style.display = "block";
        }
        
        function startGame() {
            if (!isHost) return;
            
            gameRef.update({
                status: "playing",
                currentQuestion: 0,
                questionStart: Date.now()
            });
        }
        
        function showQuestion(startTime) {
            if (currentQ >= questions.length) {
                gameRef.update({ status: "finished" });
                return;
            }
            
            answered = false;
            selected = null;
            
            const q = questions[currentQ];
            document.getElementById("display-name").textContent = playerName;
            document.getElementById("question-num").textContent = `${currentQ + 1}/${questions.length}`;
            document.getElementById("category").textContent = q.cat;
            document.getElementById("question").textContent = q.q;
            updateLives();
            
            const answersEl = document.getElementById("answers");
            answersEl.innerHTML = "";
            
            ["A", "B", "C", "D"].forEach((letter, i) => {
                const btn = document.createElement("button");
                btn.className = "answer-btn";
                btn.innerHTML = `<span class="letter">${letter}</span>${q.a[i]}`;
                btn.addEventListener("click", () => selectAnswer(btn, i));
                if (watching || lives === 0) btn.disabled = true;
                answersEl.appendChild(btn);
            });
            
            const status = document.getElementById("answer-status");
            status.className = "answer-status";
            status.textContent = "";
            
            startTimer(startTime);
        }
        
        function selectAnswer(btn, idx) {
            if (answered || lives === 0) return;
            
            answered = true;
            selected = idx;
            
            document.querySelectorAll(".answer-btn").forEach(b => {
                b.disabled = true;
                b.classList.remove("selected");
            });
            btn.classList.add("selected");
            
            const status = document.getElementById("answer-status");
            status.className = "answer-status waiting show";
            status.textContent = "‚è≥ Warte auf Timer...";
        }
        
        function startTimer(startTime) {
            if (timer) clearInterval(timer);
            
            const timerEl = document.getElementById("timer");
            const duration = 15;
            
            function tick() {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const remaining = Math.max(0, duration - elapsed);
                
                timerEl.textContent = remaining;
                timerEl.className = "timer";
                if (remaining <= 3) timerEl.classList.add("danger");
                else if (remaining <= 5) timerEl.classList.add("warning");
                
                if (remaining === 0) {
                    clearInterval(timer);
                    evaluate();
                }
            }
            
            tick();
            timer = setInterval(tick, 200);
        }
        
        function evaluate() {
            const q = questions[currentQ];
            const status = document.getElementById("answer-status");
            
            document.querySelectorAll(".answer-btn").forEach((btn, i) => {
                btn.disabled = true;
                if (i === q.c) btn.classList.add("correct");
            });
            
            if (!answered) {
                if (lives > 0) {
                    lives--;
                    wrong++;
                    playersRef.child(playerId).update({ lives });
                }
                status.className = "answer-status timeout show";
                status.textContent = "‚è∞ Zeit abgelaufen!";
            } else if (selected === q.c) {
                correct++;
                status.className = "answer-status correct show";
                status.textContent = "‚úÖ Richtig!";
            } else {
                if (lives > 0) {
                    lives--;
                    playersRef.child(playerId).update({ lives });
                }
                wrong++;
                document.querySelectorAll(".answer-btn")[selected].classList.add("wrong");
                status.className = "answer-status wrong show";
                status.textContent = `‚ùå Falsch! ${lives > 0 ? `Noch ${lives} Leben` : ''}`;
            }
            
            updateLives();
            
            if (lives === 0 && !watching) {
                setTimeout(() => {
                    document.getElementById("eliminated-overlay").style.display = "flex";
                }, 1000);
            }
            
            // Next question (host only)
            if (isHost) {
                setTimeout(() => {
                    const next = currentQ + 1;
                    if (next >= questions.length) {
                        gameRef.update({ status: "finished" });
                    } else {
                        gameRef.update({
                            currentQuestion: next,
                            questionStart: Date.now()
                        });
                    }
                }, 3000);
            }
        }
        
        function updateLives() {
            document.getElementById("display-lives").textContent = 
                lives > 0 ? "‚ù§Ô∏è".repeat(lives) + "üñ§".repeat(3-lives) : "üíÄ";
        }
        
        function endGame() {
            if (timer) clearInterval(timer);
            
            document.getElementById("game-screen").style.display = "none";
            document.getElementById("eliminated-overlay").style.display = "none";
            document.getElementById("gameover-screen").style.display = "block";
            
            document.getElementById("result-icon").textContent = lives > 0 ? "üèÜ" : "üíÄ";
            document.getElementById("result-title").textContent = lives > 0 ? "Du hast √ºberlebt!" : "Ausgeschieden!";
            document.getElementById("result-message").textContent = lives > 0 ? "Gl√ºckwunsch!" : "N√§chstes Mal!";
            
            document.getElementById("stat-correct").textContent = correct;
            document.getElementById("stat-wrong").textContent = wrong;
            document.getElementById("stat-lives").textContent = lives > 0 ? "‚ù§Ô∏è".repeat(lives) : "üíÄ";
            
            playersRef.once("value", snap => {
                const winners = [];
                snap.forEach(child => {
                    const p = child.val();
                    if (p && p.lives > 0) winners.push(p);
                });
                
                document.getElementById("winners-content").innerHTML = winners.length === 0
                    ? "<p>Niemand hat √ºberlebt! üíÄ</p>"
                    : winners.map(w => `<div class="winner-item"><span>${w.name}</span><span>${"‚ù§Ô∏è".repeat(w.lives)}</span></div>`).join("");
            });
        }
        
        function backToHome() {
            // Cleanup
            if (timer) clearInterval(timer);
            if (gameRef) gameRef.off();
            if (playersRef) {
                playersRef.off();
                if (playerId) playersRef.child(playerId).remove();
            }
            
            // Reset state
            gameCode = null;
            playerId = null;
            isHost = false;
            lives = 3;
            correct = 0;
            wrong = 0;
            currentQ = -1;
            watching = false;
            
            // Show login
            document.getElementById("lobby-screen").style.display = "none";
            document.getElementById("game-screen").style.display = "none";
            document.getElementById("gameover-screen").style.display = "none";
            document.getElementById("eliminated-overlay").style.display = "none";
            document.getElementById("login-screen").style.display = "flex";
            document.getElementById("game-code").value = "";
        }
    });
    </script>
    
    <script data-goatcounter="https://aguitoo.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>
