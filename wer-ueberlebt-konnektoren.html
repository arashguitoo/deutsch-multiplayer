<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Wer √ºberlebt? - Konnektoren</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            min-height: 100vh;
            color: white;
        }
        
        .container { max-width: 900px; margin: 0 auto; padding: 15px; }
        
        h1 {
            text-align: center;
            font-size: 1.5em;
            margin-bottom: 15px;
            text-shadow: 0 0 20px rgba(255,215,0,0.5);
        }
        
        /* Login Screen */
        #login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 85vh;
            gap: 15px;
        }
        
        .logo { font-size: 4em; animation: pulse 2s infinite; }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        #login-screen h2 { font-size: 1.2em; color: #ffd700; text-align: center; }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            max-width: 300px;
        }
        
        .input-group input {
            font-size: 1.1em;
            padding: 12px 20px;
            border: 2px solid #ffd700;
            border-radius: 25px;
            text-align: center;
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .input-group input::placeholder { color: rgba(255,255,255,0.5); }
        
        .input-group input.code-input {
            font-size: 1.5em;
            letter-spacing: 8px;
            text-transform: uppercase;
        }
        
        .btn-primary {
            font-size: 1.1em;
            padding: 15px 40px;
            border: none;
            border-radius: 30px;
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
            max-width: 300px;
        }
        
        .btn-primary:hover { transform: scale(1.03); }
        
        .btn-secondary {
            font-size: 1em;
            padding: 12px 30px;
            border: 2px solid #ffd700;
            border-radius: 25px;
            background: transparent;
            color: #ffd700;
            cursor: pointer;
            width: 100%;
            max-width: 300px;
        }
        
        .btn-secondary:hover { background: rgba(255,215,0,0.1); }
        
        .divider {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
            max-width: 300px;
            margin: 10px 0;
        }
        
        .divider::before, .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(255,255,255,0.3);
        }
        
        .divider span { color: #888; font-size: 0.9em; }
        
        /* Lobby */
        #lobby-screen { display: none; text-align: center; }
        
        .lobby-box {
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
        }
        
        .lobby-code {
            font-size: 2.5em;
            color: #ffd700;
            letter-spacing: 10px;
            margin: 10px 0;
        }
        
        .waiting-players {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
            min-height: 50px;
        }
        
        .waiting-player {
            padding: 10px 15px;
            background: rgba(255,215,0,0.2);
            border-radius: 20px;
            border: 1px solid rgba(255,215,0,0.5);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95em;
        }
        
        .waiting-player .remove-btn {
            background: rgba(255,0,0,0.4);
            border: none;
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 11px;
            line-height: 22px;
        }
        
        .waiting-player .remove-btn:hover { background: rgba(255,0,0,0.7); }
        
        .start-game-btn {
            font-size: 1.2em;
            padding: 15px 50px;
            border: none;
            border-radius: 30px;
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin: 15px 0;
        }
        
        .start-game-btn:hover { transform: scale(1.03); }
        .start-game-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .host-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .small-btn {
            font-size: 0.85em;
            padding: 8px 15px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 15px;
            background: transparent;
            color: #aaa;
            cursor: pointer;
        }
        
        .small-btn:hover { background: rgba(255,255,255,0.1); }
        .small-btn.danger { border-color: #e74c3c; color: #e74c3c; }
        
        /* Game Screen */
        #game-screen { display: none; }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .player-info { display: flex; align-items: center; gap: 10px; }
        .player-name { font-weight: bold; color: #ffd700; font-size: 0.95em; }
        .lives { font-size: 1.3em; letter-spacing: 2px; }
        
        .timer-box { text-align: center; }
        
        .timer {
            font-size: 2.2em;
            font-weight: bold;
            color: #00cec9;
            text-shadow: 0 0 20px rgba(0,206,201,0.5);
            min-width: 60px;
        }
        
        .timer.warning { color: #fdcb6e; }
        .timer.danger { color: #e74c3c; animation: timerPulse 0.5s infinite; }
        
        @keyframes timerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }
        
        .progress-info { text-align: right; }
        .question-num { font-size: 1em; color: #ffd700; }
        .survivors { font-size: 0.85em; color: #00cec9; }
        
        /* Quiz Section */
        .quiz-section {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,215,0,0.3);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .category-badge {
            display: inline-block;
            padding: 5px 15px;
            background: rgba(255,215,0,0.2);
            border-radius: 20px;
            font-size: 0.85em;
            color: #ffd700;
            margin-bottom: 12px;
        }
        
        .question { font-size: 1.25em; margin-bottom: 20px; line-height: 1.4; }
        
        .answers { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        @media (max-width: 600px) { .answers { grid-template-columns: 1fr; } }
        
        .answer-btn {
            padding: 14px 16px;
            font-size: 1em;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            background: rgba(255,255,255,0.05);
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .answer-btn:hover:not(:disabled):not(.selected) {
            background: rgba(255,215,0,0.2);
            border-color: #ffd700;
        }
        
        .answer-btn.selected {
            background: rgba(100,100,255,0.3);
            border-color: #6c5ce7;
        }
        
        .answer-btn.correct {
            background: rgba(0,184,148,0.6) !important;
            border-color: #00b894 !important;
            box-shadow: 0 0 15px rgba(0,184,148,0.5);
        }
        
        .answer-btn.wrong {
            background: rgba(214,48,49,0.6) !important;
            border-color: #d63031 !important;
        }
        
        .answer-btn:disabled { cursor: not-allowed; opacity: 0.8; }
        
        .answer-status {
            text-align: center;
            padding: 12px;
            margin-top: 15px;
            border-radius: 10px;
            font-weight: bold;
            display: none;
        }
        
        .answer-status.show { display: block; }
        .answer-status.correct { background: rgba(0,184,148,0.3); color: #55efc4; }
        .answer-status.wrong { background: rgba(214,48,49,0.3); color: #ff7675; }
        .answer-status.timeout { background: rgba(253,203,110,0.3); color: #fdcb6e; }
        
        /* Live Players */
        .live-players {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 12px;
        }
        
        .live-players h3 {
            font-size: 0.9em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .live-dot {
            width: 8px;
            height: 8px;
            background: #e74c3c;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .players-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .player-chip {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            font-size: 0.8em;
        }
        
        .player-chip.dead { opacity: 0.4; text-decoration: line-through; }
        .player-chip.is-me { border: 2px solid #ffd700; background: rgba(255,215,0,0.2); }
        
        /* Game Over */
        #gameover-screen { display: none; text-align: center; padding: 30px 20px; }
        #gameover-screen .result-icon { font-size: 4em; margin-bottom: 15px; }
        #gameover-screen h2 { font-size: 1.8em; margin-bottom: 10px; }
        #gameover-screen .result-message { font-size: 1.1em; color: #aaa; margin-bottom: 25px; }
        
        .final-stats {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: left;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .stat-row:last-child { border-bottom: none; }
        
        .winners-list {
            background: rgba(255,215,0,0.1);
            border: 2px solid rgba(255,215,0,0.3);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .winners-list h3 { color: #ffd700; margin-bottom: 12px; }
        
        .winner-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 6px;
        }
        
        /* Eliminated */
        #eliminated-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 200;
            flex-direction: column;
            gap: 15px;
        }
        
        #eliminated-overlay .skull { font-size: 5em; }
        #eliminated-overlay h2 { font-size: 1.8em; color: #d63031; }
        
        /* Connection */
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            background: rgba(0,0,0,0.5);
        }
        
        .connection-status.connected { color: #00b894; }
        .connection-status.disconnected { color: #e74c3c; }
        
        .error-msg {
            color: #e74c3c;
            font-size: 0.9em;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connection-status">Verbinde...</div>
    
    <div class="container">
        <h1>üéØ Wer √ºberlebt? - Konnektoren</h1>
        
        <!-- Login Screen -->
        <div id="login-screen">
            <div class="logo">üéØ</div>
            <h2>30 Fragen ‚Ä¢ 3 Leben ‚Ä¢ 15 Sekunden<br>dass, weil, denn, trotzdem, wenn, als</h2>
            
            <div class="input-group">
                <input type="text" id="player-name" placeholder="Dein Name" maxlength="15">
                <input type="text" id="game-code" class="code-input" placeholder="CODE" maxlength="4">
            </div>
            
            <button class="btn-primary" id="join-btn">üö™ Beitreten</button>
            
            <div class="divider"><span>oder</span></div>
            
            <button class="btn-secondary" id="create-btn">üëë Neues Spiel erstellen</button>
            
            <div class="error-msg" id="error-msg"></div>
        </div>
        
        <!-- Lobby Screen -->
        <div id="lobby-screen">
            <div class="lobby-box">
                <h2>‚è≥ Warteraum</h2>
                <div class="lobby-code" id="lobby-code">CODE</div>
                <p style="color: #888; font-size: 0.85em; margin-bottom: 15px;">Teile diesen Code</p>
                
                <div class="waiting-players" id="waiting-players">
                    <p style="color: #666;">Warte auf Spieler...</p>
                </div>
                
                <div id="host-controls">
                    <button class="start-game-btn" id="start-game-btn" disabled>‚ñ∂Ô∏è SPIEL STARTEN</button>
                    <p style="color: #00b894; font-size: 0.85em;">üëë Du bist der Spielleiter</p>
                    
                    <div class="host-actions">
                        <button class="small-btn danger" id="clear-players-btn">üóëÔ∏è Alle entfernen</button>
                        <button class="small-btn danger" id="reset-game-btn">üîÑ Zur√ºcksetzen</button>
                    </div>
                </div>
                
                <div id="player-controls" style="display: none;">
                    <p style="color: #fdcb6e; font-size: 1.1em;">‚è≥ Warte auf Spielleiter...</p>
                </div>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="game-screen">
            <div class="game-header">
                <div class="player-info">
                    <span class="player-name" id="display-name"></span>
                    <span class="lives" id="display-lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
                </div>
                <div class="timer-box">
                    <div class="timer" id="timer">15</div>
                </div>
                <div class="progress-info">
                    <div class="question-num" id="question-num">1/30</div>
                    <div class="survivors" id="survivors">üë• 0</div>
                </div>
            </div>
            
            <div class="quiz-section">
                <div class="category-badge" id="category">Konnektoren</div>
                <div class="question" id="question"></div>
                <div class="answers" id="answers"></div>
                <div class="answer-status" id="answer-status"></div>
            </div>
            
            <div class="live-players">
                <h3><span class="live-dot"></span> Spieler</h3>
                <div class="players-grid" id="players-grid"></div>
            </div>
        </div>
        
        <!-- Game Over -->
        <div id="gameover-screen">
            <div class="result-icon" id="result-icon">üèÜ</div>
            <h2 id="result-title">Spiel beendet!</h2>
            <p class="result-message" id="result-message"></p>
            
            <div class="final-stats">
                <div class="stat-row"><span>Richtig</span><span id="stat-correct">0</span></div>
                <div class="stat-row"><span>Falsch</span><span id="stat-wrong">0</span></div>
                <div class="stat-row"><span>Leben</span><span id="stat-lives">0</span></div>
            </div>
            
            <div class="winners-list">
                <h3>üèÜ √úberlebende</h3>
                <div id="winners-content"></div>
            </div>
            
            <button class="btn-primary" id="back-home-btn">üè† Zur√ºck zum Start</button>
        </div>
        
        <!-- Eliminated -->
        <div id="eliminated-overlay">
            <div class="skull">üíÄ</div>
            <h2>Ausgeschieden!</h2>
            <p style="color: #aaa;">Du kannst weiter zuschauen</p>
            <button class="btn-secondary" id="watch-btn">üëÄ Zuschauen</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        
        if (typeof firebase === 'undefined') {
            document.getElementById('error-msg').textContent = "Firebase konnte nicht geladen werden.";
            return;
        }
        
        firebase.initializeApp({
            apiKey: "AIzaSyBDChXlm34Kr7Gg0Dw458GiiwoLnWJAnxM",
            authDomain: "lern-deutsch-arash.firebaseapp.com",
            databaseURL: "https://lern-deutsch-arash-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "lern-deutsch-arash",
            storageBucket: "lern-deutsch-arash.firebasestorage.app",
            messagingSenderId: "845503292114",
            appId: "1:845503292114:web:f76ab5fcde1e978d00c30b"
        });
        
        const db = firebase.database();
        
        // 30 Fragen zu Konnektoren
        const questions = [
            // DASS (5)
            { cat: "dass", q: "Ich hoffe, ___ du morgen kommst.", a: ["dass", "weil", "denn", "wenn"], c: 0 },
            { cat: "dass", q: "Er sagt, ___ er keine Zeit hat.", a: ["dass", "weil", "obwohl", "denn"], c: 0 },
            { cat: "dass", q: "Ich wei√ü, ___ das schwer ist.", a: ["dass", "wenn", "als", "denn"], c: 0 },
            { cat: "dass", q: "Es ist wichtig, ___ du p√ºnktlich bist.", a: ["dass", "weil", "denn", "trotzdem"], c: 0 },
            { cat: "dass", q: "Ich glaube, ___ er recht hat.", a: ["dass", "wenn", "weil", "als"], c: 0 },
            
            // WEIL (5)
            { cat: "weil", q: "Ich bleibe zu Hause, ___ ich krank bin.", a: ["weil", "dass", "denn", "trotzdem"], c: 0 },
            { cat: "weil", q: "Sie ist m√ºde, ___ sie lange gearbeitet hat.", a: ["weil", "dass", "wenn", "als"], c: 0 },
            { cat: "weil", q: "Er lernt Deutsch, ___ er in Deutschland arbeiten will.", a: ["weil", "denn", "dass", "trotzdem"], c: 0 },
            { cat: "weil", q: "Ich kann nicht kommen, ___ ich einen Termin habe.", a: ["weil", "dass", "denn", "wenn"], c: 0 },
            { cat: "weil", q: "Sie weint, ___ sie traurig ist.", a: ["weil", "dass", "trotzdem", "als"], c: 0 },
            
            // DENN (5)
            { cat: "denn", q: "Ich gehe nicht raus, ___ es regnet.", a: ["denn", "weil", "dass", "trotzdem"], c: 0 },
            { cat: "denn", q: "Er isst nichts, ___ er hat keinen Hunger.", a: ["denn", "weil", "dass", "wenn"], c: 0 },
            { cat: "denn", q: "Sie kommt sp√§ter, ___ sie muss noch arbeiten.", a: ["denn", "weil", "dass", "als"], c: 0 },
            { cat: "denn", q: "Ich helfe dir, ___ du bist mein Freund.", a: ["denn", "weil", "dass", "trotzdem"], c: 0 },
            { cat: "denn", q: "Wir fahren mit dem Bus, ___ das Auto ist kaputt.", a: ["denn", "weil", "dass", "wenn"], c: 0 },
            
            // TROTZDEM (5)
            { cat: "trotzdem", q: "Es regnet. ___ gehe ich spazieren.", a: ["Trotzdem", "Weil", "Dass", "Denn"], c: 0 },
            { cat: "trotzdem", q: "Er ist m√ºde. ___ arbeitet er weiter.", a: ["Trotzdem", "Weil", "Wenn", "Denn"], c: 0 },
            { cat: "trotzdem", q: "Ich habe Kopfschmerzen. ___ gehe ich zur Arbeit.", a: ["Trotzdem", "Dass", "Weil", "Als"], c: 0 },
            { cat: "trotzdem", q: "Das Essen ist teuer. ___ kaufe ich es.", a: ["Trotzdem", "Denn", "Weil", "Wenn"], c: 0 },
            { cat: "trotzdem", q: "Sie hat wenig Zeit. ___ hilft sie mir.", a: ["Trotzdem", "Dass", "Weil", "Denn"], c: 0 },
            
            // WENN (5)
            { cat: "wenn", q: "___ du kommst, freue ich mich.", a: ["Wenn", "Als", "Dass", "Weil"], c: 0 },
            { cat: "wenn", q: "___ es regnet, bleibe ich zu Hause.", a: ["Wenn", "Als", "Denn", "Trotzdem"], c: 0 },
            { cat: "wenn", q: "Ich rufe dich an, ___ ich fertig bin.", a: ["wenn", "als", "dass", "denn"], c: 0 },
            { cat: "wenn", q: "___ ich Zeit habe, lese ich gern.", a: ["Wenn", "Als", "Weil", "Dass"], c: 0 },
            { cat: "wenn", q: "Er wird gl√ºcklich sein, ___ er das h√∂rt.", a: ["wenn", "als", "denn", "trotzdem"], c: 0 },
            
            // ALS (5)
            { cat: "als", q: "___ ich ein Kind war, wohnte ich in Berlin.", a: ["Als", "Wenn", "Weil", "Dass"], c: 0 },
            { cat: "als", q: "___ er ankam, war es schon dunkel.", a: ["Als", "Wenn", "Denn", "Trotzdem"], c: 0 },
            { cat: "als", q: "Ich war traurig, ___ du gegangen bist.", a: ["als", "wenn", "dass", "weil"], c: 0 },
            { cat: "als", q: "___ ich jung war, spielte ich Fu√üball.", a: ["Als", "Wenn", "Weil", "Denn"], c: 0 },
            { cat: "als", q: "Sie hat geweint, ___ sie den Film gesehen hat.", a: ["als", "wenn", "dass", "trotzdem"], c: 0 }
        ];
        
        // State
        let gameCode = null;
        let playerId = null;
        let playerName = null;
        let isHost = false;
        let lives = 3;
        let correct = 0;
        let wrong = 0;
        let currentQ = -1;
        let answered = false;
        let selected = null;
        let timer = null;
        let watching = false;
        let gameRef = null;
        let playersRef = null;
        
        // Connection
        db.ref(".info/connected").on("value", snap => {
            const el = document.getElementById("connection-status");
            el.textContent = snap.val() ? "üü¢ Online" : "üî¥ Offline";
            el.className = "connection-status " + (snap.val() ? "connected" : "disconnected");
        });
        
        // Generate 4-letter code
        function generateCode() {
            const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
            let code = "";
            for (let i = 0; i < 4; i++) code += chars[Math.floor(Math.random() * chars.length)];
            return code;
        }
        
        // Event listeners
        document.getElementById("create-btn").addEventListener("click", createGame);
        document.getElementById("join-btn").addEventListener("click", joinGame);
        document.getElementById("start-game-btn").addEventListener("click", startGame);
        document.getElementById("clear-players-btn").addEventListener("click", clearPlayers);
        document.getElementById("reset-game-btn").addEventListener("click", resetGame);
        document.getElementById("back-home-btn").addEventListener("click", backToHome);
        document.getElementById("watch-btn").addEventListener("click", () => {
            watching = true;
            document.getElementById("eliminated-overlay").style.display = "none";
        });
        
        document.getElementById("game-code").addEventListener("keypress", e => {
            if (e.key === "Enter") joinGame();
        });
        
        function showError(msg) {
            document.getElementById("error-msg").textContent = msg;
            setTimeout(() => document.getElementById("error-msg").textContent = "", 3000);
        }
        
        function createGame() {
            playerName = document.getElementById("player-name").value.trim();
            if (!playerName) { showError("Bitte Name eingeben!"); return; }
            
            gameCode = generateCode();
            playerId = "host_" + Date.now();
            isHost = true;
            
            gameRef = db.ref("konnektoren/" + gameCode);
            playersRef = db.ref("konnektoren/" + gameCode + "/players");
            
            gameRef.remove().then(() => {
                return gameRef.set({
                    status: "lobby",
                    currentQuestion: -1,
                    questionStart: null,
                    host: playerId,
                    created: Date.now()
                });
            }).then(() => {
                return playersRef.child(playerId).set({
                    name: playerName,
                    lives: 3,
                    isHost: true
                });
            }).then(() => {
                playersRef.child(playerId).onDisconnect().remove();
                showLobby();
                setupListeners();
            }).catch(err => showError("Fehler: " + err.message));
        }
        
        function joinGame() {
            playerName = document.getElementById("player-name").value.trim();
            gameCode = document.getElementById("game-code").value.trim().toUpperCase();
            
            if (!playerName) { showError("Bitte Name eingeben!"); return; }
            if (!gameCode || gameCode.length !== 4) { showError("Bitte 4-stelligen Code!"); return; }
            
            playerId = "p_" + Date.now() + "_" + Math.random().toString(36).substr(2,4);
            isHost = false;
            
            gameRef = db.ref("konnektoren/" + gameCode);
            playersRef = db.ref("konnektoren/" + gameCode + "/players");
            
            gameRef.once("value").then(snap => {
                if (!snap.exists()) { showError("Spiel nicht gefunden!"); return; }
                if (snap.val().status !== "lobby") { showError("Spiel l√§uft bereits!"); return; }
                
                return playersRef.child(playerId).set({
                    name: playerName,
                    lives: 3,
                    isHost: false
                });
            }).then(() => {
                if (!playerId) return;
                playersRef.child(playerId).onDisconnect().remove();
                showLobby();
                setupListeners();
            }).catch(err => showError("Fehler: " + err.message));
        }
        
        function showLobby() {
            document.getElementById("login-screen").style.display = "none";
            document.getElementById("lobby-screen").style.display = "block";
            document.getElementById("lobby-code").textContent = gameCode;
            
            document.getElementById("host-controls").style.display = isHost ? "block" : "none";
            document.getElementById("player-controls").style.display = isHost ? "none" : "block";
        }
        
        function setupListeners() {
            playersRef.on("value", snap => {
                const players = [];
                snap.forEach(child => {
                    const d = child.val();
                    if (d && d.name) players.push({ id: child.key, ...d });
                });
                updatePlayers(players);
            });
            
            gameRef.on("value", snap => {
                const game = snap.val();
                if (!game) { backToHome(); return; }
                
                if (game.status === "playing") {
                    document.getElementById("lobby-screen").style.display = "none";
                    document.getElementById("game-screen").style.display = "block";
                    
                    if (game.currentQuestion !== currentQ) {
                        currentQ = game.currentQuestion;
                        showQuestion(game.questionStart);
                    }
                } else if (game.status === "finished") {
                    endGame();
                }
            });
        }
        
        function updatePlayers(players) {
            // Lobby
            const waitingEl = document.getElementById("waiting-players");
            if (players.length === 0) {
                waitingEl.innerHTML = '<p style="color:#666">Warte auf Spieler...</p>';
            } else {
                waitingEl.innerHTML = players.map(p => `
                    <div class="waiting-player">
                        <span>${p.name} ${p.isHost ? 'üëë' : ''}</span>
                        ${isHost && !p.isHost ? `<button class="remove-btn" data-id="${p.id}">‚úï</button>` : ''}
                    </div>
                `).join("");
                
                waitingEl.querySelectorAll(".remove-btn").forEach(btn => {
                    btn.addEventListener("click", () => playersRef.child(btn.dataset.id).remove());
                });
            }
            
            const nonHost = players.filter(p => !p.isHost);
            document.getElementById("start-game-btn").disabled = nonHost.length === 0;
            
            // Game screen
            const grid = document.getElementById("players-grid");
            const alive = players.filter(p => p.lives > 0);
            document.getElementById("survivors").textContent = `üë• ${alive.length}`;
            
            grid.innerHTML = players.map(p => `
                <div class="player-chip ${p.lives === 0 ? 'dead' : ''} ${p.id === playerId ? 'is-me' : ''}">
                    <span>${p.name}</span>
                    <span>${p.lives > 0 ? '‚ù§Ô∏è'.repeat(p.lives) : 'üíÄ'}</span>
                </div>
            `).join("");
        }
        
        function clearPlayers() {
            if (!confirm("Alle Spieler entfernen (au√üer dir)?")) return;
            playersRef.once("value", snap => {
                snap.forEach(child => {
                    if (child.key !== playerId) playersRef.child(child.key).remove();
                });
            });
        }
        
        function resetGame() {
            if (!confirm("Spiel zur√ºcksetzen?")) return;
            gameRef.update({ status: "lobby", currentQuestion: -1, questionStart: null });
            playersRef.once("value", snap => {
                snap.forEach(child => playersRef.child(child.key).update({ lives: 3 }));
            });
            lives = 3; correct = 0; wrong = 0; currentQ = -1; watching = false;
            document.getElementById("game-screen").style.display = "none";
            document.getElementById("gameover-screen").style.display = "none";
            document.getElementById("eliminated-overlay").style.display = "none";
            document.getElementById("lobby-screen").style.display = "block";
        }
        
        function startGame() {
            if (!isHost) return;
            gameRef.update({ status: "playing", currentQuestion: 0, questionStart: Date.now() });
        }
        
        function showQuestion(startTime) {
            if (currentQ >= questions.length) {
                gameRef.update({ status: "finished" });
                return;
            }
            
            answered = false;
            selected = null;
            
            const q = questions[currentQ];
            document.getElementById("display-name").textContent = playerName;
            document.getElementById("question-num").textContent = `${currentQ + 1}/${questions.length}`;
            document.getElementById("category").textContent = q.cat;
            document.getElementById("question").textContent = q.q;
            updateLives();
            
            // Shuffle
            const shuffled = q.a.map((text, origIdx) => ({ text, origIdx }));
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            
            const answersEl = document.getElementById("answers");
            answersEl.innerHTML = "";
            
            shuffled.forEach((item, i) => {
                const btn = document.createElement("button");
                btn.className = "answer-btn";
                btn.textContent = item.text;
                btn.dataset.origIdx = item.origIdx;
                btn.addEventListener("click", () => selectAnswer(btn, item.origIdx));
                if (watching || lives === 0) btn.disabled = true;
                answersEl.appendChild(btn);
            });
            
            document.getElementById("answer-status").className = "answer-status";
            startTimer(startTime);
        }
        
        function selectAnswer(btn, idx) {
            if (answered || lives === 0) return;
            answered = true;
            selected = idx;
            
            document.querySelectorAll(".answer-btn").forEach(b => {
                b.disabled = true;
                b.classList.remove("selected");
            });
            btn.classList.add("selected");
        }
        
        function startTimer(startTime) {
            if (timer) clearInterval(timer);
            const timerEl = document.getElementById("timer");
            const duration = 15;
            
            function tick() {
                const remaining = Math.max(0, duration - Math.floor((Date.now() - startTime) / 1000));
                timerEl.textContent = remaining;
                timerEl.className = "timer" + (remaining <= 3 ? " danger" : remaining <= 5 ? " warning" : "");
                
                if (remaining === 0) {
                    clearInterval(timer);
                    evaluate();
                }
            }
            tick();
            timer = setInterval(tick, 200);
        }
        
        function evaluate() {
            const q = questions[currentQ];
            const status = document.getElementById("answer-status");
            
            document.querySelectorAll(".answer-btn").forEach(btn => {
                btn.disabled = true;
                if (parseInt(btn.dataset.origIdx) === q.c) btn.classList.add("correct");
            });
            
            if (!answered) {
                if (lives > 0) { lives--; wrong++; playersRef.child(playerId).update({ lives }); }
                status.className = "answer-status timeout show";
                status.textContent = "‚è∞ Zeit abgelaufen!";
            } else if (selected === q.c) {
                correct++;
                status.className = "answer-status correct show";
                status.textContent = "‚úÖ Richtig!";
            } else {
                if (lives > 0) { lives--; playersRef.child(playerId).update({ lives }); }
                wrong++;
                document.querySelectorAll(".answer-btn").forEach(btn => {
                    if (parseInt(btn.dataset.origIdx) === selected) btn.classList.add("wrong");
                });
                status.className = "answer-status wrong show";
                status.textContent = `‚ùå Falsch! ${lives > 0 ? `Noch ${lives} Leben` : ''}`;
            }
            
            updateLives();
            
            if (lives === 0 && !watching) {
                setTimeout(() => {
                    document.getElementById("eliminated-overlay").style.display = "flex";
                }, 1000);
            }
            
            if (isHost) {
                setTimeout(() => {
                    const next = currentQ + 1;
                    if (next >= questions.length) {
                        gameRef.update({ status: "finished" });
                    } else {
                        gameRef.update({ currentQuestion: next, questionStart: Date.now() });
                    }
                }, 3000);
            }
        }
        
        function updateLives() {
            document.getElementById("display-lives").textContent = 
                lives > 0 ? "‚ù§Ô∏è".repeat(lives) + "üñ§".repeat(3-lives) : "üíÄ";
        }
        
        function endGame() {
            if (timer) clearInterval(timer);
            
            document.getElementById("game-screen").style.display = "none";
            document.getElementById("eliminated-overlay").style.display = "none";
            document.getElementById("gameover-screen").style.display = "block";
            
            document.getElementById("result-icon").textContent = lives > 0 ? "üèÜ" : "üíÄ";
            document.getElementById("result-title").textContent = lives > 0 ? "Du hast √ºberlebt!" : "Ausgeschieden!";
            document.getElementById("result-message").textContent = lives > 0 ? "Gl√ºckwunsch!" : "N√§chstes Mal!";
            
            document.getElementById("stat-correct").textContent = correct;
            document.getElementById("stat-wrong").textContent = wrong;
            document.getElementById("stat-lives").textContent = lives > 0 ? "‚ù§Ô∏è".repeat(lives) : "üíÄ";
            
            playersRef.once("value", snap => {
                const winners = [];
                snap.forEach(child => {
                    const p = child.val();
                    if (p && p.lives > 0) winners.push(p);
                });
                
                document.getElementById("winners-content").innerHTML = winners.length === 0
                    ? "<p>Niemand hat √ºberlebt! üíÄ</p>"
                    : winners.map(w => `<div class="winner-item"><span>${w.name}</span><span>${"‚ù§Ô∏è".repeat(w.lives)}</span></div>`).join("");
            });
        }
        
        function backToHome() {
            if (timer) clearInterval(timer);
            if (gameRef) gameRef.off();
            if (playersRef) {
                playersRef.off();
                if (playerId) playersRef.child(playerId).remove();
            }
            
            gameCode = playerId = null;
            isHost = false;
            lives = 3; correct = 0; wrong = 0; currentQ = -1; watching = false;
            
            document.getElementById("lobby-screen").style.display = "none";
            document.getElementById("game-screen").style.display = "none";
            document.getElementById("gameover-screen").style.display = "none";
            document.getElementById("eliminated-overlay").style.display = "none";
            document.getElementById("login-screen").style.display = "flex";
            document.getElementById("game-code").value = "";
        }
    });
    </script>
    
    <script data-goatcounter="https://aguitoo.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>
