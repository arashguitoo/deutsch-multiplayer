<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÉ Wer ist schneller? - Grammatik Sprint</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#fff}
        .container{max-width:900px;margin:0 auto;padding:15px}
        h1{text-align:center;font-size:1.5em;margin-bottom:15px}
        .screen{display:none}.screen.active{display:block}
        
        /* Login */
        #login-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:85vh;gap:15px}
        .logo{font-size:4em;margin-bottom:10px}
        #login-screen h2{font-size:1.2em;color:#ffd700;text-align:center}
        .difficulty-select{display:flex;gap:10px;margin:15px 0;flex-wrap:wrap;justify-content:center}
        .diff-btn{padding:15px 25px;border:3px solid rgba(255,255,255,0.3);border-radius:15px;background:rgba(255,255,255,0.1);color:#fff;font-size:1em;font-weight:700;cursor:pointer;transition:all 0.3s}
        .diff-btn:hover,.diff-btn.selected{transform:scale(1.05)}
        .diff-btn.einfach{border-color:#00b894}.diff-btn.einfach.selected{background:#00b894}
        .diff-btn.mittel{border-color:#fdcb6e}.diff-btn.mittel.selected{background:#e17055}
        .diff-btn.schwer{border-color:#d63031}.diff-btn.schwer.selected{background:#d63031}
        .input-group{display:flex;flex-direction:column;gap:10px;width:100%;max-width:300px}
        .input-group input{font-size:1.1em;padding:12px 20px;border:2px solid #ffd700;border-radius:25px;text-align:center;background:rgba(255,255,255,0.1);color:#fff}
        .input-group input::placeholder{color:rgba(255,255,255,0.5)}
        .input-group input.code-input{font-size:1.4em;letter-spacing:8px;text-transform:uppercase}
        .btn-primary{font-size:1.1em;padding:15px 40px;border:none;border-radius:30px;background:linear-gradient(135deg,#00b894,#00cec9);color:#fff;font-weight:700;cursor:pointer;width:100%;max-width:300px}
        .btn-secondary{font-size:1em;padding:12px 30px;border:2px solid #ffd700;border-radius:25px;background:transparent;color:#ffd700;cursor:pointer;width:100%;max-width:300px}
        .divider{display:flex;align-items:center;gap:15px;width:100%;max-width:300px;margin:5px 0}
        .divider::before,.divider::after{content:'';flex:1;height:1px;background:rgba(255,255,255,0.3)}
        .error-msg{color:#ff6b6b;font-size:0.9em;margin-top:10px}
        
        /* Lobby */
        #lobby-screen{text-align:center}
        .lobby-box{background:rgba(255,255,255,0.1);border-radius:20px;padding:25px;margin:20px 0}
        .lobby-code{font-size:2.5em;color:#ffd700;letter-spacing:10px;margin:10px 0}
        .diff-badge{display:inline-block;padding:8px 20px;border-radius:20px;font-weight:700;margin:10px 0}
        .diff-badge.einfach{background:#00b894}.diff-badge.mittel{background:#e17055}.diff-badge.schwer{background:#d63031}
        .waiting-players{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:20px 0;min-height:50px}
        .waiting-player{padding:10px 15px;background:rgba(255,215,0,0.2);border-radius:20px;border:1px solid rgba(255,215,0,0.5);display:flex;align-items:center;gap:8px}
        .start-game-btn{font-size:1.2em;padding:15px 50px;border:none;border-radius:30px;background:linear-gradient(135deg,#00b894,#00cec9);color:#fff;font-weight:700;cursor:pointer;margin:15px 0}
        .start-game-btn:disabled{opacity:0.5;cursor:not-allowed}
        .small-btn{font-size:0.85em;padding:8px 15px;border:1px solid rgba(255,255,255,0.3);border-radius:15px;background:transparent;color:#aaa;cursor:pointer;margin:5px}
        .small-btn.danger{border-color:#e74c3c;color:#e74c3c}
        
        /* Game */
        .game-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding:12px 15px;background:rgba(255,255,255,0.1);border-radius:15px;flex-wrap:wrap;gap:10px}
        .timer{font-size:2.5em;font-weight:700;color:#00cec9}.timer.warning{color:#fdcb6e}.timer.danger{color:#e74c3c;animation:pulse 0.5s infinite}
        @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
        .score-display{font-size:1.3em;color:#ffd700}
        .question-num{color:#aaa}
        
        .quiz-section{background:rgba(255,255,255,0.05);border:2px solid rgba(255,215,0,0.3);border-radius:20px;padding:20px;margin-bottom:15px}
        .category-badge{display:inline-block;padding:5px 15px;background:rgba(255,215,0,0.2);border-radius:20px;font-size:0.85em;color:#ffd700;margin-bottom:12px}
        .question{font-size:1.3em;margin-bottom:20px;line-height:1.5}
        .answers{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        @media(max-width:500px){.answers{grid-template-columns:1fr}}
        .answer-btn{padding:15px;font-size:1em;border:2px solid rgba(255,255,255,0.3);border-radius:12px;background:rgba(255,255,255,0.05);color:#fff;cursor:pointer;transition:all 0.2s}
        .answer-btn:hover:not(:disabled){background:rgba(255,215,0,0.2);border-color:#ffd700}
        .answer-btn.selected{background:rgba(108,92,231,0.4);border-color:#6c5ce7}
        .answer-btn.correct{background:rgba(0,184,148,0.7)!important;border-color:#00b894!important}
        .answer-btn.wrong{background:rgba(214,48,49,0.7)!important;border-color:#d63031!important}
        .answer-btn:disabled{cursor:not-allowed}
        
        .leaderboard{background:rgba(255,255,255,0.05);border-radius:15px;padding:15px;margin-top:15px}
        .leaderboard h3{font-size:1em;margin-bottom:10px;color:#ffd700}
        .lb-row{display:flex;justify-content:space-between;padding:8px 12px;background:rgba(255,255,255,0.05);border-radius:8px;margin-bottom:5px}
        .lb-row.me{background:rgba(255,215,0,0.2);border:1px solid #ffd700}
        
        /* Results */
        #result-screen{text-align:center;padding:30px 20px}
        .result-icon{font-size:5em;margin-bottom:15px}
        .podium{display:flex;justify-content:center;align-items:flex-end;gap:10px;margin:30px 0}
        .podium-place{text-align:center;padding:15px;border-radius:15px 15px 0 0}
        .podium-place.first{background:linear-gradient(135deg,#ffd700,#ff8c00);height:150px;order:2}
        .podium-place.second{background:linear-gradient(135deg,#c0c0c0,#a0a0a0);height:120px;order:1}
        .podium-place.third{background:linear-gradient(135deg,#cd7f32,#a0522d);height:90px;order:3}
        .podium-name{font-weight:700;font-size:1.1em}
        .podium-score{font-size:0.9em;opacity:0.8}
        .podium-medal{font-size:2em}
        
        .connection-status{position:fixed;top:10px;right:10px;padding:5px 10px;border-radius:12px;font-size:0.75em;background:rgba(0,0,0,0.5)}
        .connection-status.connected{color:#00b894}
    </style>
</head>
<body>
    <div class="connection-status" id="connection-status">Verbinde...</div>
    <div class="container">
        <h1>üèÉ Wer ist schneller?</h1>
        
        <div id="login-screen" class="screen active">
            <div class="logo">üèÉ</div>
            <h2>Grammatik Sprint<br><small style="color:#aaa">Wer antwortet am schnellsten richtig?</small></h2>
            <div class="difficulty-select">
                <button class="diff-btn einfach" data-diff="einfach">üü¢ Einfach</button>
                <button class="diff-btn mittel" data-diff="mittel">üü° Mittel</button>
                <button class="diff-btn schwer" data-diff="schwer">üî¥ Schwer</button>
            </div>
            <div class="input-group">
                <input type="text" id="player-name" placeholder="Dein Name" maxlength="15">
                <input type="text" id="game-code" class="code-input" placeholder="CODE" maxlength="4">
            </div>
            <button class="btn-primary" id="join-btn">üö™ Beitreten</button>
            <div class="divider"><span>oder</span></div>
            <button class="btn-secondary" id="create-btn">üëë Neues Spiel erstellen</button>
            <div class="error-msg" id="error-msg"></div>
        </div>
        
        <div id="lobby-screen" class="screen">
            <div class="lobby-box">
                <h2>‚è≥ Warteraum</h2>
                <div class="lobby-code" id="lobby-code">CODE</div>
                <div class="diff-badge" id="diff-badge">Einfach</div>
                <p style="color:#888;font-size:0.85em">20 Fragen ‚Ä¢ Schnellster gewinnt!</p>
                <div class="waiting-players" id="waiting-players"></div>
                <div id="host-controls">
                    <button class="start-game-btn" id="start-btn" disabled>‚ñ∂Ô∏è START</button>
                    <p style="color:#00b894;font-size:0.85em">üëë Du bist der Spielleiter</p>
                    <button class="small-btn danger" id="reset-btn">üîÑ Zur√ºcksetzen</button>
                </div>
                <div id="player-controls" style="display:none">
                    <p style="color:#fdcb6e">‚è≥ Warte auf Spielleiter...</p>
                </div>
            </div>
        </div>
        
        <div id="game-screen" class="screen">
            <div class="game-header">
                <div class="score-display">‚≠ê <span id="my-score">0</span></div>
                <div class="timer" id="timer">10</div>
                <div class="question-num" id="question-num">1/20</div>
            </div>
            <div class="quiz-section">
                <div class="category-badge" id="category"></div>
                <div class="question" id="question"></div>
                <div class="answers" id="answers"></div>
            </div>
            <div class="leaderboard">
                <h3>üèÜ Live-Rangliste</h3>
                <div id="live-leaderboard"></div>
            </div>
        </div>
        
        <div id="result-screen" class="screen">
            <div class="result-icon" id="result-icon">üèÜ</div>
            <h2 id="result-title">Spiel beendet!</h2>
            <div class="podium" id="podium"></div>
            <button class="btn-primary" id="back-btn">üè† Zur√ºck</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script>
    (function() {
        var firebaseConfig = {
            apiKey: "AIzaSyBDChXlm34Kr7Gg0Dw458GiiwoLnWJAnxM",
            authDomain: "lern-deutsch-arash.firebaseapp.com",
            databaseURL: "https://lern-deutsch-arash-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "lern-deutsch-arash"
        };
        firebase.initializeApp(firebaseConfig);
        var db = firebase.database();
        
        // Questions by difficulty
        var questions = {
            einfach: [
                {cat:"Modalverben",q:"Ich ___ Deutsch lernen.",a:["muss","musst","m√ºssen","m√ºsst"],c:0},
                {cat:"Modalverben",q:"Du ___ nicht rauchen.",a:["darfst","darf","d√ºrfen","d√ºrft"],c:0},
                {cat:"Modalverben",q:"Er ___ gut schwimmen.",a:["kann","kannst","k√∂nnen","k√∂nnt"],c:0},
                {cat:"Modalverben",q:"Wir ___ nach Hause gehen.",a:["wollen","will","wollt","willst"],c:0},
                {cat:"Modalverben",q:"Ihr ___ leise sein.",a:["sollt","soll","sollen","sollst"],c:0},
                {cat:"Artikel",q:"Das ist ___ Buch.",a:["ein","eine","einen","einem"],c:0},
                {cat:"Artikel",q:"Ich sehe ___ Mann.",a:["einen","ein","einer","einem"],c:0},
                {cat:"Artikel",q:"Sie hat ___ Katze.",a:["eine","ein","einen","einer"],c:0},
                {cat:"Pronomen",q:"Ich helfe ___.",a:["dir","dich","du","dein"],c:0},
                {cat:"Pronomen",q:"Er gibt ___ das Buch.",a:["mir","mich","ich","mein"],c:0},
                {cat:"Pronomen",q:"Wir sehen ___.",a:["euch","ihr","euer","euren"],c:0},
                {cat:"Verben",q:"Er ___ gern Fu√üball.",a:["spielt","spielen","spielst","spiele"],c:0},
                {cat:"Verben",q:"Wir ___ Kaffee.",a:["trinken","trinkt","trinkst","trinke"],c:0},
                {cat:"Verben",q:"Ich ___ ein Buch.",a:["lese","liest","lesen","lest"],c:0},
                {cat:"dass-S√§tze",q:"Ich hoffe, ___ du kommst.",a:["dass","das","weil","wenn"],c:0},
                {cat:"dass-S√§tze",q:"Er sagt, ___ er m√ºde ist.",a:["dass","das","weil","denn"],c:0},
                {cat:"wenn-S√§tze",q:"___ du Zeit hast, ruf mich an.",a:["Wenn","Wann","Als","Ob"],c:0},
                {cat:"wenn-S√§tze",q:"___ es regnet, bleibe ich zu Hause.",a:["Wenn","Wann","Als","Ob"],c:0},
                {cat:"Pr√§positionen",q:"Ich gehe ___ Hause.",a:["nach","zu","in","auf"],c:0},
                {cat:"Pr√§positionen",q:"Das Buch liegt ___ dem Tisch.",a:["auf","in","an","√ºber"],c:0}
            ],
            mittel: [
                {cat:"Reflexivverben",q:"Ich ___ mich jeden Morgen.",a:["wasche","waschst","waschen","w√§scht"],c:0},
                {cat:"Reflexivverben",q:"Er ___ sich auf die Pr√ºfung vor.",a:["bereitet","bereite","bereitest","bereiten"],c:0},
                {cat:"Reflexivverben",q:"Du musst ___ beeilen!",a:["dich","sich","mich","uns"],c:0},
                {cat:"Reflexivverben",q:"Sie interessiert ___ f√ºr Musik.",a:["sich","mich","dich","uns"],c:0},
                {cat:"Verben+Pr√§p.",q:"Ich warte ___ den Bus.",a:["auf","f√ºr","an","√ºber"],c:0},
                {cat:"Verben+Pr√§p.",q:"Er denkt oft ___ seine Familie.",a:["an","auf","√ºber","f√ºr"],c:0},
                {cat:"Verben+Pr√§p.",q:"Sie freut sich ___ das Wochenende.",a:["auf","√ºber","f√ºr","an"],c:0},
                {cat:"Verben+Pr√§p.",q:"Ich interessiere mich ___ Sport.",a:["f√ºr","an","auf","√ºber"],c:0},
                {cat:"Modalverben Pr√§t.",q:"Ich ___ gestern nicht kommen.",a:["konnte","k√∂nnte","kann","gekonnt"],c:0},
                {cat:"Modalverben Pr√§t.",q:"Er ___ fr√ºher aufstehen.",a:["musste","m√ºsste","muss","gemusst"],c:0},
                {cat:"Modalverben Pr√§t.",q:"Als Kind ___ ich kein Gem√ºse.",a:["mochte","mag","m√∂chte","gemocht"],c:0},
                {cat:"Konjunktiv II",q:"Du ___ mehr schlafen.",a:["solltest","sollst","sollte","sollen"],c:0},
                {cat:"Konjunktiv II",q:"Wir ___ ins Kino gehen.",a:["k√∂nnten","k√∂nnen","k√∂nnte","k√∂nntest"],c:0},
                {cat:"Konjunktiv II",q:"Ich ___ lieber Tee trinken.",a:["w√ºrde","werde","wird","w√ºrden"],c:0},
                {cat:"Dativ",q:"Ich schenke ___ ein Buch.",a:["dir","dich","du","deiner"],c:0},
                {cat:"Dativ",q:"Er gibt ___ das Geld.",a:["mir","mich","ich","meiner"],c:0},
                {cat:"Dativ",q:"Sie zeigt ___ die Fotos.",a:["uns","wir","unser","unsere"],c:0},
                {cat:"Konnektoren",q:"Ich bleibe zu Hause, ___ ich krank bin.",a:["weil","dass","denn","trotzdem"],c:0},
                {cat:"Konnektoren",q:"Es regnet. ___ gehe ich spazieren.",a:["Trotzdem","Weil","Dass","Denn"],c:0},
                {cat:"Konnektoren",q:"Ich gehe nicht raus, ___ es regnet.",a:["denn","weil","dass","trotzdem"],c:0}
            ],
            schwer: [
                {cat:"Konjunktiv II",q:"___ Sie bitte den Bericht schreiben?",a:["K√∂nnten","K√∂nnen","Konnten","K√∂nnte"],c:0},
                {cat:"Konjunktiv II",q:"Das ___ super!",a:["w√§re","ist","war","wird"],c:0},
                {cat:"Konjunktiv II",q:"Ich ___ gern fr√ºher gekommen.",a:["w√§re","h√§tte","w√ºrde","bin"],c:0},
                {cat:"Konjunktiv II",q:"Das ___ ich nicht gedacht.",a:["h√§tte","habe","hatte","w√§re"],c:0},
                {cat:"Reflexiv+Pr√§p.",q:"Lisa ___ ___ ihr neues Auto.",a:["freut sich √ºber","freut √ºber sich","sich freut √ºber","freut sich auf"],c:0},
                {cat:"Reflexiv+Pr√§p.",q:"Er ___ ___ einen Experten wenden.",a:["sollte sich an","sollte an sich","sich sollte an","an sich sollte"],c:0},
                {cat:"Pronominaladverb",q:"Ich √§rgere mich √ºber die Versp√§tung. ‚Üí Ich √§rgere mich ___.",a:["dar√ºber","daran","daf√ºr","davon"],c:0},
                {cat:"Pronominaladverb",q:"Er wartet auf den Bus. ‚Üí Er wartet ___.",a:["darauf","daran","daf√ºr","davon"],c:0},
                {cat:"Pronominaladverb",q:"Sie denkt an ihre Pr√ºfung. ‚Üí Sie denkt oft ___.",a:["daran","darauf","daf√ºr","dar√ºber"],c:0},
                {cat:"als/wenn",q:"___ ich ein Kind war, wohnte ich in Berlin.",a:["Als","Wenn","Weil","Dass"],c:0},
                {cat:"als/wenn",q:"___ er ankam, war es schon dunkel.",a:["Als","Wenn","Weil","Denn"],c:0},
                {cat:"Satzbau",q:"Welcher Satz ist korrekt?",a:["Es tut mir leid, dass ich nicht kommen konnte.","Es tut mir leid, das ich nicht kommen konnte.","Es tut mir leid, weil ich nicht kommen konnte.","Es mir leid tut, dass ich nicht kommen konnte."],c:0},
                {cat:"Satzbau",q:"Welcher Satz ist korrekt?",a:["Wenn man erfolgreich sein will, muss man viel arbeiten.","Wen man erfolgreich sein will, muss man viel arbeiten.","Wenn man erfolgreich sein will, man muss viel arbeiten.","Als man erfolgreich sein will, muss man viel arbeiten."],c:0},
                {cat:"Modalverben",q:"Als Sch√ºler ___ wir Hausaufgaben machen, aber wir ___ danach drau√üen spielen.",a:["mussten...durften","m√ºssen...d√ºrfen","m√ºssten...d√ºrften","gemusst...gedurft"],c:0},
                {cat:"Arbeitswelt",q:"Was bedeutet '√úberstunden'?",a:["Mehr arbeiten als normal","Weniger arbeiten","Urlaub","Pause"],c:0},
                {cat:"Arbeitswelt",q:"Was ist ein 'Gehalt'?",a:["Geld f√ºr die Arbeit","Ein B√ºro","Ein Chef","Ein Praktikum"],c:0},
                {cat:"H√∂flichkeit",q:"Wie fragt man h√∂flich? '___ Sie mir bitte helfen?'",a:["K√∂nnten","K√∂nnen","M√ºssen","Sollen"],c:0},
                {cat:"H√∂flichkeit",q:"Ich ___ gern eine Frage stellen.",a:["w√ºrde","werde","will","wollte"],c:0},
                {cat:"Bedauern",q:"Ich ___ gern dabei gewesen. (Vergangenheit)",a:["w√§re","h√§tte","w√ºrde","bin"],c:0},
                {cat:"Bedauern",q:"Das ___ nicht passieren d√ºrfen.",a:["h√§tte","hat","hatte","w√§re"],c:0}
            ]
        };
        
        let gameCode, playerId, playerName, isHost = false, difficulty = 'einfach';
        let currentQ = -1, myScore = 0, answered = false, timerInt = null;
        let gameRef, playersRef, allPlayers = [], gameQuestions = [];
        
        // Connection status
        db.ref(".info/connected").on("value", s => {
            const el = document.getElementById("connection-status");
            el.textContent = s.val() ? "üü¢ Online" : "üî¥ Offline";
            el.className = "connection-status " + (s.val() ? "connected" : "disconnected");
        });
        
        // Difficulty selection
        document.querySelectorAll('.diff-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                difficulty = btn.dataset.diff;
            };
        });
        document.querySelector('.diff-btn.einfach').classList.add('selected');
        
        function genCode() {
            const c = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
            return Array(4).fill(0).map(() => c[Math.floor(Math.random() * c.length)]).join('');
        }
        
        function showError(m) {
            document.getElementById("error-msg").textContent = m;
            setTimeout(() => document.getElementById("error-msg").textContent = "", 3000);
        }
        
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
        
        function shuffle(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }
        
        // Create game
        document.getElementById("create-btn").onclick = function() {
            playerName = document.getElementById("player-name").value.trim();
            if (!playerName) { showError("Name eingeben!"); return; }
            
            gameCode = genCode();
            playerId = "host_" + Date.now();
            isHost = true;
            
            // Shuffle and select 20 questions
            gameQuestions = shuffle([...questions[difficulty]]).slice(0, 20);
            
            gameRef = db.ref("schneller/" + gameCode);
            playersRef = db.ref("schneller/" + gameCode + "/players");
            
            gameRef.remove().then(() => {
                return gameRef.set({
                    status: "lobby",
                    difficulty: difficulty,
                    currentQuestion: -1,
                    questionStart: null,
                    questions: gameQuestions,
                    host: playerId
                });
            }).then(() => {
                return playersRef.child(playerId).set({
                    name: playerName,
                    score: 0,
                    isHost: true,
                    answered: false
                });
            }).then(() => {
                playersRef.child(playerId).onDisconnect().remove();
                showLobby();
                setupListeners();
            });
        };
        
        // Join game
        document.getElementById("join-btn").onclick = function() {
            playerName = document.getElementById("player-name").value.trim();
            gameCode = document.getElementById("game-code").value.trim().toUpperCase();
            
            if (!playerName) { showError("Name eingeben!"); return; }
            if (!gameCode || gameCode.length !== 4) { showError("4-stelliger Code!"); return; }
            
            playerId = "p_" + Date.now() + "_" + Math.random().toString(36).substr(2, 4);
            isHost = false;
            
            gameRef = db.ref("schneller/" + gameCode);
            playersRef = db.ref("schneller/" + gameCode + "/players");
            
            gameRef.once("value").then(s => {
                if (!s.exists()) { showError("Spiel nicht gefunden!"); return Promise.reject(); }
                if (s.val().status !== "lobby") { showError("Spiel l√§uft bereits!"); return Promise.reject(); }
                
                difficulty = s.val().difficulty;
                gameQuestions = s.val().questions;
                
                return playersRef.child(playerId).set({
                    name: playerName,
                    score: 0,
                    isHost: false,
                    answered: false
                });
            }).then(() => {
                playersRef.child(playerId).onDisconnect().remove();
                showLobby();
                setupListeners();
            }).catch(() => {});
        };
        
        document.getElementById("game-code").onkeypress = e => { if (e.key === "Enter") document.getElementById("join-btn").click(); };
        
        function showLobby() {
            showScreen("lobby-screen");
            document.getElementById("lobby-code").textContent = gameCode;
            
            const badge = document.getElementById("diff-badge");
            badge.textContent = difficulty.charAt(0).toUpperCase() + difficulty.slice(1);
            badge.className = "diff-badge " + difficulty;
            
            document.getElementById("host-controls").style.display = isHost ? "block" : "none";
            document.getElementById("player-controls").style.display = isHost ? "none" : "block";
        }
        
        function setupListeners() {
            playersRef.on("value", snap => {
                const players = [];
                snap.forEach(c => {
                    const d = c.val();
                    if (d && d.name) players.push({ id: c.key, ...d });
                });
                allPlayers = players;
                updateLobbyPlayers(players);
                updateLeaderboard();
            });
            
            gameRef.on("value", snap => {
                const game = snap.val();
                if (!game) { backToHome(); return; }
                
                if (game.status === "playing") {
                    showScreen("game-screen");
                    if (game.currentQuestion !== currentQ) {
                        currentQ = game.currentQuestion;
                        answered = false;
                        showQuestion(game.questionStart);
                    }
                } else if (game.status === "finished") {
                    showResults();
                }
            });
        }
        
        function updateLobbyPlayers(players) {
            const w = document.getElementById("waiting-players");
            w.innerHTML = players.length === 0 ? '<p style="color:#666">Warte auf Spieler...</p>' :
                players.map(p => `<div class="waiting-player"><span>${p.name} ${p.isHost ? 'üëë' : ''}</span></div>`).join("");
            document.getElementById("start-btn").disabled = players.filter(p => !p.isHost).length === 0;
        }
        
        function updateLeaderboard() {
            const sorted = [...allPlayers].sort((a, b) => b.score - a.score);
            document.getElementById("live-leaderboard").innerHTML = sorted.map(p => 
                `<div class="lb-row ${p.id === playerId ? 'me' : ''}">
                    <span>${p.name}</span>
                    <span>‚≠ê ${p.score}</span>
                </div>`
            ).join("");
        }
        
        // Start game
        document.getElementById("start-btn").onclick = function() {
            if (!isHost) return;
            playersRef.once("value", s => {
                s.forEach(c => playersRef.child(c.key).update({ answered: false, score: 0 }));
                gameRef.update({ status: "playing", currentQuestion: 0, questionStart: Date.now() });
            });
        };
        
        // Reset game
        document.getElementById("reset-btn").onclick = function() {
            if (!confirm("Zur√ºcksetzen?")) return;
            gameRef.update({ status: "lobby", currentQuestion: -1, questionStart: null });
            playersRef.once("value", s => s.forEach(c => playersRef.child(c.key).update({ score: 0, answered: false })));
            myScore = 0;
            currentQ = -1;
            showScreen("lobby-screen");
        };
        
        function showQuestion(startTime) {
            if (currentQ >= gameQuestions.length) {
                gameRef.update({ status: "finished" });
                return;
            }
            
            const q = gameQuestions[currentQ];
            document.getElementById("question-num").textContent = `${currentQ + 1}/${gameQuestions.length}`;
            document.getElementById("category").textContent = q.cat;
            document.getElementById("question").textContent = q.q;
            document.getElementById("my-score").textContent = myScore;
            
            // Shuffle answers
            const idx = [0, 1, 2, 3];
            shuffle(idx);
            
            const ans = document.getElementById("answers");
            ans.innerHTML = "";
            idx.forEach(origIdx => {
                const btn = document.createElement("button");
                btn.className = "answer-btn";
                btn.textContent = q.a[origIdx];
                btn.dataset.origIdx = origIdx;
                btn.onclick = () => selectAnswer(btn, origIdx);
                ans.appendChild(btn);
            });
            
            startTimer(startTime);
        }
        
        function selectAnswer(btn, idx) {
            if (answered) return;
            answered = true;
            
            const q = gameQuestions[currentQ];
            const isCorrect = idx === q.c;
            
            document.querySelectorAll(".answer-btn").forEach(b => {
                b.disabled = true;
                if (parseInt(b.dataset.origIdx) === q.c) b.classList.add("correct");
            });
            
            if (isCorrect) {
                // Points based on remaining time
                const remaining = parseInt(document.getElementById("timer").textContent);
                const points = Math.max(1, remaining);
                myScore += points;
                document.getElementById("my-score").textContent = myScore;
                playersRef.child(playerId).update({ score: myScore, answered: true });
            } else {
                btn.classList.add("wrong");
                playersRef.child(playerId).update({ answered: true });
            }
        }
        
        function startTimer(startTime) {
            if (timerInt) clearInterval(timerInt);
            const el = document.getElementById("timer");
            
            function tick() {
                const rem = Math.max(0, 10 - Math.floor((Date.now() - startTime) / 1000));
                el.textContent = rem;
                el.className = "timer" + (rem <= 2 ? " danger" : rem <= 4 ? " warning" : "");
                
                if (rem === 0) {
                    clearInterval(timerInt);
                    if (!answered) {
                        answered = true;
                        // Show correct answer
                        const q = gameQuestions[currentQ];
                        document.querySelectorAll(".answer-btn").forEach(b => {
                            b.disabled = true;
                            if (parseInt(b.dataset.origIdx) === q.c) b.classList.add("correct");
                        });
                        playersRef.child(playerId).update({ answered: true });
                    }
                    
                    // Host advances to next question
                    if (isHost) {
                        setTimeout(() => {
                            if (currentQ + 1 >= gameQuestions.length) {
                                gameRef.update({ status: "finished" });
                            } else {
                                playersRef.once("value", s => {
                                    s.forEach(c => playersRef.child(c.key).update({ answered: false }));
                                    gameRef.update({ currentQuestion: currentQ + 1, questionStart: Date.now() });
                                });
                            }
                        }, 2000);
                    }
                }
            }
            tick();
            timerInt = setInterval(tick, 200);
        }
        
        function showResults() {
            if (timerInt) clearInterval(timerInt);
            showScreen("result-screen");
            
            const sorted = [...allPlayers].sort((a, b) => b.score - a.score);
            const myRank = sorted.findIndex(p => p.id === playerId) + 1;
            
            document.getElementById("result-icon").textContent = myRank === 1 ? "ü•á" : myRank === 2 ? "ü•à" : myRank === 3 ? "ü•â" : "üèÅ";
            document.getElementById("result-title").textContent = myRank === 1 ? "Du hast gewonnen!" : `Platz ${myRank}!`;
            
            // Podium
            const podium = document.getElementById("podium");
            podium.innerHTML = "";
            
            for (let i = 0; i < Math.min(3, sorted.length); i++) {
                const p = sorted[i];
                const place = document.createElement("div");
                place.className = `podium-place ${i === 0 ? 'first' : i === 1 ? 'second' : 'third'}`;
                place.innerHTML = `
                    <div class="podium-medal">${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : 'ü•â'}</div>
                    <div class="podium-name">${p.name}</div>
                    <div class="podium-score">‚≠ê ${p.score}</div>
                `;
                podium.appendChild(place);
            }
        }
        
        document.getElementById("back-btn").onclick = backToHome;
        
        function backToHome() {
            if (timerInt) clearInterval(timerInt);
            if (gameRef) gameRef.off();
            if (playersRef) {
                playersRef.off();
                if (playerId) playersRef.child(playerId).remove();
            }
            gameCode = playerId = null;
            isHost = false;
            myScore = 0;
            currentQ = -1;
            showScreen("login-screen");
            document.getElementById("game-code").value = "";
        }
    })();
    </script>
    <script data-goatcounter="https://aguitoo.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>
