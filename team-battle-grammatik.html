<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öîÔ∏è Team Battle: Grammatik</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);min-height:100vh;color:#fff}
        .container{max-width:900px;margin:0 auto;padding:15px}
        h1{text-align:center;font-size:1.5em;margin-bottom:15px}
        .screen{display:none}.screen.active{display:block}
        
        #login-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:85vh;gap:15px}
        .logo{font-size:4em;margin-bottom:10px}
        #login-screen h2{font-size:1.2em;color:#ffd700;text-align:center}
        .difficulty-select{display:flex;gap:10px;margin:15px 0;flex-wrap:wrap;justify-content:center}
        .diff-btn{padding:15px 25px;border:3px solid rgba(255,255,255,0.3);border-radius:15px;background:rgba(255,255,255,0.1);color:#fff;font-size:1em;font-weight:700;cursor:pointer;transition:all 0.3s}
        .diff-btn:hover,.diff-btn.selected{transform:scale(1.05)}
        .diff-btn.einfach{border-color:#00b894}.diff-btn.einfach.selected{background:#00b894}
        .diff-btn.mittel{border-color:#fdcb6e}.diff-btn.mittel.selected{background:#e17055}
        .diff-btn.schwer{border-color:#d63031}.diff-btn.schwer.selected{background:#d63031}
        .input-group{display:flex;flex-direction:column;gap:10px;width:100%;max-width:300px}
        .input-group input,.input-group select{font-size:1.1em;padding:12px 20px;border:2px solid #ffd700;border-radius:25px;text-align:center;background:rgba(255,255,255,0.1);color:#fff}
        .input-group select{background:rgba(255,255,255,0.1)}
        .input-group select option{background:#1a1a2e;color:#fff}
        .input-group input::placeholder{color:rgba(255,255,255,0.5)}
        .input-group input.code-input{font-size:1.4em;letter-spacing:8px;text-transform:uppercase}
        .btn-primary{font-size:1.1em;padding:15px 40px;border:none;border-radius:30px;background:linear-gradient(135deg,#e74c3c,#c0392b);color:#fff;font-weight:700;cursor:pointer;width:100%;max-width:300px}
        .btn-secondary{font-size:1em;padding:12px 30px;border:2px solid #ffd700;border-radius:25px;background:transparent;color:#ffd700;cursor:pointer;width:100%;max-width:300px}
        .divider{display:flex;align-items:center;gap:15px;width:100%;max-width:300px;margin:5px 0}
        .divider::before,.divider::after{content:'';flex:1;height:1px;background:rgba(255,255,255,0.3)}
        .error-msg{color:#ff6b6b;font-size:0.9em;margin-top:10px}
        
        #lobby-screen{text-align:center}
        .lobby-box{background:rgba(255,255,255,0.1);border-radius:20px;padding:25px;margin:20px 0}
        .lobby-code{font-size:2.5em;color:#ffd700;letter-spacing:10px;margin:10px 0}
        .diff-badge{display:inline-block;padding:8px 20px;border-radius:20px;font-weight:700;margin:10px 0}
        .diff-badge.einfach{background:#00b894}.diff-badge.mittel{background:#e17055}.diff-badge.schwer{background:#d63031}
        
        .teams-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin:20px 0}
        @media(max-width:500px){.teams-grid{grid-template-columns:1fr}}
        .team-box{background:rgba(255,255,255,0.05);border-radius:15px;padding:15px;border:2px solid rgba(255,255,255,0.1)}
        .team-box h3{margin-bottom:10px}
        .team-box.mond{border-color:#9c88ff}.team-box.sonne{border-color:#ffb142}.team-box.stern{border-color:#ff6b81}.team-box.ozean{border-color:#22a6b3}
        .team-players{min-height:40px;display:flex;flex-wrap:wrap;gap:5px}
        .team-player{padding:5px 10px;background:rgba(255,255,255,0.1);border-radius:10px;font-size:0.85em}
        
        .start-game-btn{font-size:1.2em;padding:15px 50px;border:none;border-radius:30px;background:linear-gradient(135deg,#e74c3c,#c0392b);color:#fff;font-weight:700;cursor:pointer;margin:15px 0}
        .start-game-btn:disabled{opacity:0.5;cursor:not-allowed}
        .small-btn{font-size:0.85em;padding:8px 15px;border:1px solid rgba(255,255,255,0.3);border-radius:15px;background:transparent;color:#aaa;cursor:pointer;margin:5px}
        .small-btn.danger{border-color:#e74c3c;color:#e74c3c}
        
        .scoreboard{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:15px}
        @media(max-width:600px){.scoreboard{grid-template-columns:1fr 1fr}}
        .team-score{padding:12px;border-radius:12px;text-align:center}
        .team-score.mond{background:rgba(156,136,255,0.2);border:2px solid #9c88ff}
        .team-score.sonne{background:rgba(255,177,66,0.2);border:2px solid #ffb142}
        .team-score.stern{background:rgba(255,107,129,0.2);border:2px solid #ff6b81}
        .team-score.ozean{background:rgba(34,166,179,0.2);border:2px solid #22a6b3}
        .team-score .emoji{font-size:1.5em}.team-score .points{font-size:1.3em;font-weight:700}
        
        .game-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding:12px 15px;background:rgba(255,255,255,0.1);border-radius:15px;flex-wrap:wrap;gap:10px}
        .timer{font-size:2em;font-weight:700;color:#00cec9}.timer.warning{color:#fdcb6e}.timer.danger{color:#e74c3c;animation:pulse 0.5s infinite}
        @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
        
        .quiz-section{background:rgba(255,255,255,0.05);border:2px solid rgba(255,215,0,0.3);border-radius:20px;padding:20px;margin-bottom:15px}
        .category-badge{display:inline-block;padding:5px 15px;background:rgba(255,215,0,0.2);border-radius:20px;font-size:0.85em;color:#ffd700;margin-bottom:12px}
        .question{font-size:1.2em;margin-bottom:20px;line-height:1.5}
        .answers{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        @media(max-width:500px){.answers{grid-template-columns:1fr}}
        .answer-btn{padding:15px;font-size:1em;border:2px solid rgba(255,255,255,0.3);border-radius:12px;background:rgba(255,255,255,0.05);color:#fff;cursor:pointer;transition:all 0.2s}
        .answer-btn:hover:not(:disabled){background:rgba(255,215,0,0.2);border-color:#ffd700}
        .answer-btn.selected{background:rgba(108,92,231,0.4);border-color:#6c5ce7}
        .answer-btn.correct{background:rgba(0,184,148,0.7)!important;border-color:#00b894!important}
        .answer-btn.wrong{background:rgba(214,48,49,0.7)!important;border-color:#d63031!important}
        .answer-btn:disabled{cursor:not-allowed}
        
        .answer-status{text-align:center;padding:12px;margin-top:15px;border-radius:10px;font-weight:700}
        .answer-status.hidden{display:none!important}
        .answer-status.waiting{background:rgba(108,92,231,0.3);color:#a29bfe}
        .answer-status.correct{background:rgba(0,184,148,0.3);color:#55efc4}
        .answer-status.wrong{background:rgba(214,48,49,0.3);color:#ff7675}
        .answer-status.timeout{background:rgba(253,203,110,0.3);color:#fdcb6e}
        
        #gameover-screen{text-align:center;padding:30px 20px}
        .result-icon{font-size:5em;margin-bottom:15px}
        .final-scores{background:rgba(255,255,255,0.1);border-radius:15px;padding:20px;margin-bottom:20px}
        .final-team{display:flex;justify-content:space-between;align-items:center;padding:12px;margin-bottom:8px;border-radius:10px}
        .final-team.winner{background:rgba(255,215,0,0.2);border:2px solid #ffd700}
        
        .connection-status{position:fixed;top:10px;right:10px;padding:5px 10px;border-radius:12px;font-size:0.75em;background:rgba(0,0,0,0.5)}
        .connection-status.connected{color:#00b894}
    </style>
</head>
<body>
    <div class="connection-status" id="connection-status">Verbinde...</div>
    <div class="container">
        <h1>‚öîÔ∏è Team Battle: Grammatik</h1>
        
        <div id="login-screen" class="screen active">
            <div class="logo">‚öîÔ∏è</div>
            <h2>Konjunktiv II & Modalverben<br><small style="color:#aaa">4 Teams ‚Ä¢ 25 Fragen ‚Ä¢ Wer gewinnt?</small></h2>
            <div class="difficulty-select">
                <button class="diff-btn einfach" data-diff="einfach">üü¢ Einfach</button>
                <button class="diff-btn mittel" data-diff="mittel">üü° Mittel</button>
                <button class="diff-btn schwer" data-diff="schwer">üî¥ Schwer</button>
            </div>
            <div class="input-group">
                <input type="text" id="player-name" placeholder="Dein Name" maxlength="15">
                <select id="team-select">
                    <option value="">-- Team w√§hlen --</option>
                    <option value="mond">üåô Expedition Mond</option>
                    <option value="sonne">‚òÄÔ∏è Expedition Sonne</option>
                    <option value="stern">‚≠ê Expedition Stern</option>
                    <option value="ozean">üåä Expedition Ozean</option>
                </select>
                <input type="text" id="game-code" class="code-input" placeholder="CODE" maxlength="4">
            </div>
            <button class="btn-primary" id="join-btn">üö™ Beitreten</button>
            <div class="divider"><span>oder</span></div>
            <button class="btn-secondary" id="create-btn">üëë Neues Spiel erstellen</button>
            <div class="error-msg" id="error-msg"></div>
        </div>
        
        <div id="lobby-screen" class="screen">
            <div class="lobby-box">
                <h2>‚è≥ Warteraum</h2>
                <div class="lobby-code" id="lobby-code">CODE</div>
                <div class="diff-badge" id="diff-badge">Einfach</div>
                <div class="teams-grid">
                    <div class="team-box mond"><h3>üåô Mond</h3><div class="team-players" id="team-mond"></div></div>
                    <div class="team-box sonne"><h3>‚òÄÔ∏è Sonne</h3><div class="team-players" id="team-sonne"></div></div>
                    <div class="team-box stern"><h3>‚≠ê Stern</h3><div class="team-players" id="team-stern"></div></div>
                    <div class="team-box ozean"><h3>üåä Ozean</h3><div class="team-players" id="team-ozean"></div></div>
                </div>
                <div id="host-controls">
                    <button class="start-game-btn" id="start-btn" disabled>‚ñ∂Ô∏è START</button>
                    <p style="color:#00b894;font-size:0.85em">üëë Du bist der Spielleiter</p>
                    <button class="small-btn danger" id="reset-btn">üîÑ Zur√ºcksetzen</button>
                </div>
                <div id="player-controls" style="display:none">
                    <p style="color:#fdcb6e">‚è≥ Warte auf Spielleiter...</p>
                </div>
            </div>
        </div>
        
        <div id="game-screen" class="screen">
            <div class="scoreboard">
                <div class="team-score mond"><div class="emoji">üåô</div><div class="points" id="score-mond">0</div></div>
                <div class="team-score sonne"><div class="emoji">‚òÄÔ∏è</div><div class="points" id="score-sonne">0</div></div>
                <div class="team-score stern"><div class="emoji">‚≠ê</div><div class="points" id="score-stern">0</div></div>
                <div class="team-score ozean"><div class="emoji">üåä</div><div class="points" id="score-ozean">0</div></div>
            </div>
            <div class="game-header">
                <div id="question-num">1/25</div>
                <div class="timer" id="timer">15</div>
                <div id="my-team"></div>
            </div>
            <div class="quiz-section">
                <div class="category-badge" id="category"></div>
                <div class="question" id="question"></div>
                <div class="answers" id="answers"></div>
                <div class="answer-status hidden" id="answer-status"></div>
            </div>
        </div>
        
        <div id="gameover-screen" class="screen">
            <div class="result-icon" id="result-icon">üèÜ</div>
            <h2 id="result-title">Spiel beendet!</h2>
            <div class="final-scores" id="final-scores"></div>
            <button class="btn-primary" id="back-btn">üè† Zur√ºck</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        firebase.initializeApp({
            apiKey: "AIzaSyBDChXlm34Kr7Gg0Dw458GiiwoLnWJAnxM",
            authDomain: "lern-deutsch-arash.firebaseapp.com",
            databaseURL: "https://lern-deutsch-arash-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "lern-deutsch-arash"
        });
        const db = firebase.database();
        
        const questions = {
            einfach: [
                {cat:"Modalverben",q:"Ich ___ Deutsch lernen.",a:["muss","musst","m√ºssen","m√ºsst"],c:0},
                {cat:"Modalverben",q:"Du ___ nicht rauchen.",a:["darfst","darf","d√ºrfen","d√ºrft"],c:0},
                {cat:"Modalverben",q:"Er ___ gut schwimmen.",a:["kann","kannst","k√∂nnen","k√∂nnt"],c:0},
                {cat:"Modalverben",q:"Wir ___ nach Hause gehen.",a:["wollen","will","wollt","willst"],c:0},
                {cat:"Modalverben",q:"Ihr ___ leise sein.",a:["sollt","soll","sollen","sollst"],c:0},
                {cat:"Konjunktiv II",q:"Du ___ mehr schlafen. (Ratschlag)",a:["solltest","sollst","sollte","sollen"],c:0},
                {cat:"Konjunktiv II",q:"Wir ___ ins Kino gehen. (Vorschlag)",a:["k√∂nnten","k√∂nnen","k√∂nnte","k√∂nntest"],c:0},
                {cat:"Konjunktiv II",q:"Ich ___ lieber Tee. (Wunsch)",a:["h√§tte","habe","hatte","haben"],c:0},
                {cat:"Konjunktiv II",q:"Er ___ lieber Pizza essen.",a:["w√ºrde","werde","wird","werden"],c:0},
                {cat:"Konjunktiv II",q:"Das ___ super!",a:["w√§re","ist","war","wird"],c:0},
                {cat:"Dativ",q:"Ich schenke ___ ein Buch. (du)",a:["dir","dich","du","dein"],c:0},
                {cat:"Dativ",q:"Er gibt ___ das Geld. (ich)",a:["mir","mich","ich","mein"],c:0},
                {cat:"Dativ",q:"Sie zeigt ___ die Fotos. (wir)",a:["uns","wir","unser","unsere"],c:0},
                {cat:"wenn-S√§tze",q:"___ du Zeit hast, ruf mich an.",a:["Wenn","Wann","Als","Ob"],c:0},
                {cat:"wenn-S√§tze",q:"___ es regnet, bleibe ich zu Hause.",a:["Wenn","Wann","Als","Ob"],c:0},
                {cat:"dass-S√§tze",q:"Ich hoffe, ___ du kommst.",a:["dass","das","weil","wenn"],c:0},
                {cat:"dass-S√§tze",q:"Er sagt, ___ er m√ºde ist.",a:["dass","das","weil","denn"],c:0},
                {cat:"Reflexivverben",q:"Ich ___ mich jeden Morgen.",a:["wasche","waschst","waschen","w√§scht"],c:0},
                {cat:"Reflexivverben",q:"Du musst ___ beeilen!",a:["dich","sich","mich","uns"],c:0},
                {cat:"Pr√§positionen",q:"Ich warte ___ den Bus.",a:["auf","f√ºr","an","√ºber"],c:0},
                {cat:"Modalverben",q:"Sie ___ gut kochen.",a:["kann","k√∂nnen","kannst","k√∂nnt"],c:0},
                {cat:"Konjunktiv II",q:"Ihr ___ fr√ºher kommen. (Vorschlag)",a:["k√∂nntet","k√∂nnt","k√∂nnen","k√∂nntest"],c:0},
                {cat:"Dativ",q:"Gib ___ bitte den Stift! (ich)",a:["mir","mich","ich","mein"],c:0},
                {cat:"wenn-S√§tze",q:"___ du fertig bist, sag Bescheid.",a:["Wenn","Wann","Als","Weil"],c:0},
                {cat:"Reflexivverben",q:"Er ___ sich auf die Pr√ºfung vor.",a:["bereitet","bereite","bereitest","bereiten"],c:0}
            ],
            mittel: [
                {cat:"Modalverben Pr√§t.",q:"Ich ___ gestern nicht kommen.",a:["konnte","k√∂nnte","kann","gekonnt"],c:0},
                {cat:"Modalverben Pr√§t.",q:"Er ___ fr√ºher aufstehen.",a:["musste","m√ºsste","muss","gemusst"],c:0},
                {cat:"Modalverben Pr√§t.",q:"Als Kind ___ ich kein Gem√ºse.",a:["mochte","mag","m√∂chte","gemocht"],c:0},
                {cat:"Modalverben Pr√§t.",q:"Wir ___ lange warten.",a:["mussten","m√ºssen","m√ºssten","gemusst"],c:0},
                {cat:"Modalverben Pr√§t.",q:"Als Jugendlicher ___ ich bis 22 Uhr wegbleiben.",a:["durfte","d√ºrfte","darf","gedurft"],c:0},
                {cat:"Konjunktiv II",q:"___ Sie bitte das Fenster √∂ffnen?",a:["K√∂nnten","K√∂nnen","Konnten","K√∂nnte"],c:0},
                {cat:"Konjunktiv II",q:"Ich ___ gern eine Frage stellen.",a:["w√ºrde","werde","will","wollte"],c:0},
                {cat:"Konjunktiv II",q:"___ du mir bitte helfen?",a:["K√∂nntest","Kannst","Konntest","K√∂nnte"],c:0},
                {cat:"Konjunktiv II",q:"Wir ___ gern mitkommen.",a:["w√ºrden","werden","wollen","wollten"],c:0},
                {cat:"Konjunktiv II",q:"Er ___ lieber zu Hause bleiben.",a:["w√ºrde","werde","will","wollte"],c:0},
                {cat:"Verben+Pr√§p.",q:"Er denkt oft ___ seine Familie.",a:["an","auf","√ºber","f√ºr"],c:0},
                {cat:"Verben+Pr√§p.",q:"Sie freut sich ___ das Wochenende.",a:["auf","√ºber","f√ºr","an"],c:0},
                {cat:"Verben+Pr√§p.",q:"Ich interessiere mich ___ Sport.",a:["f√ºr","an","auf","√ºber"],c:0},
                {cat:"Verben+Pr√§p.",q:"Er bittet mich ___ Hilfe.",a:["um","f√ºr","auf","nach"],c:0},
                {cat:"Verben+Pr√§p.",q:"Sie √§rgert sich ___ den Fehler.",a:["√ºber","auf","f√ºr","an"],c:0},
                {cat:"Reflexivverben",q:"Wir ___ uns √ºber das Geschenk.",a:["freuen","freut","freue","freust"],c:0},
                {cat:"Reflexivverben",q:"Sie interessiert ___ f√ºr Musik.",a:["sich","mich","dich","uns"],c:0},
                {cat:"Reflexivverben",q:"K√∂nnt ihr ___ das vorstellen?",a:["euch","sich","uns","mir"],c:0},
                {cat:"Dativ",q:"Er bringt ___ einen Kaffee. (sie/Sg.)",a:["ihr","sie","ihren","ihre"],c:0},
                {cat:"Dativ",q:"Ich schicke ___ eine Nachricht. (er)",a:["ihm","ihn","er","seiner"],c:0},
                {cat:"Konnektoren",q:"Ich bleibe zu Hause, ___ ich krank bin.",a:["weil","dass","denn","trotzdem"],c:0},
                {cat:"Konnektoren",q:"Es regnet. ___ gehe ich spazieren.",a:["Trotzdem","Weil","Dass","Denn"],c:0},
                {cat:"Konnektoren",q:"Ich gehe nicht raus, ___ es regnet.",a:["denn","weil","dass","trotzdem"],c:0},
                {cat:"als/wenn",q:"___ ich ein Kind war, wohnte ich in Berlin.",a:["Als","Wenn","Weil","Dass"],c:0},
                {cat:"als/wenn",q:"___ er ankommt, sag mir Bescheid. (immer)",a:["Wenn","Als","Weil","Denn"],c:0}
            ],
            schwer: [
                {cat:"Konjunktiv II Verg.",q:"Ich ___ gern fr√ºher gekommen.",a:["w√§re","h√§tte","w√ºrde","bin"],c:0},
                {cat:"Konjunktiv II Verg.",q:"Das ___ ich nicht gedacht.",a:["h√§tte","habe","hatte","w√§re"],c:0},
                {cat:"Konjunktiv II Verg.",q:"Wir ___ gern dabei gewesen.",a:["w√§ren","h√§tten","w√ºrden","sind"],c:0},
                {cat:"Konjunktiv II Verg.",q:"Das ___ nicht passieren d√ºrfen.",a:["h√§tte","hat","hatte","w√§re"],c:0},
                {cat:"Konjunktiv II Verg.",q:"Sie ___ lieber zu Hause geblieben.",a:["w√§re","h√§tte","w√ºrde","ist"],c:0},
                {cat:"Pronominaladverb",q:"Ich √§rgere mich √ºber die Versp√§tung. ‚Üí Ich √§rgere mich ___.",a:["dar√ºber","daran","daf√ºr","davon"],c:0},
                {cat:"Pronominaladverb",q:"Er wartet auf den Bus. ‚Üí Er wartet ___.",a:["darauf","daran","daf√ºr","davon"],c:0},
                {cat:"Pronominaladverb",q:"Sie denkt an ihre Pr√ºfung. ‚Üí Sie denkt oft ___.",a:["daran","darauf","daf√ºr","dar√ºber"],c:0},
                {cat:"Pronominaladverb",q:"Er freut sich auf den Urlaub. ‚Üí Er freut sich ___.",a:["darauf","daran","dar√ºber","daf√ºr"],c:0},
                {cat:"Pronominaladverb",q:"Sie tr√§umt von einem Haus. ‚Üí Sie tr√§umt ___.",a:["davon","daran","darauf","daf√ºr"],c:0},
                {cat:"Reflexiv+Pr√§p.",q:"Wenn Sie Probleme haben, sollten Sie ___ ___ einen Experten wenden.",a:["sich an","an sich","sich zu","zu sich"],c:0},
                {cat:"Reflexiv+Pr√§p.",q:"Er ___ ___ das neue Projekt.",a:["freut sich auf","freut auf sich","sich freut auf","auf sich freut"],c:0},
                {cat:"Reflexiv+Pr√§p.",q:"Sie ___ ___ ihren Erfolg.",a:["freut sich √ºber","freut √ºber sich","sich freut √ºber","√ºber sich freut"],c:0},
                {cat:"Satzbau",q:"Welcher Satz ist korrekt?",a:["Es tut mir leid, dass ich nicht kommen konnte.","Es tut mir leid, das ich nicht kommen konnte.","Es mir tut leid, dass ich nicht kommen konnte.","Es tut mir leid, weil ich nicht kommen konnte."],c:0},
                {cat:"Satzbau",q:"Welcher Satz ist korrekt?",a:["Wenn man erfolgreich sein will, muss man viel arbeiten.","Wen man erfolgreich sein will, muss man viel arbeiten.","Wenn man erfolgreich sein will, man muss viel arbeiten.","Als man erfolgreich sein will, muss man viel arbeiten."],c:0},
                {cat:"Modalverben",q:"Als Sch√ºler ___ wir Hausaufgaben machen, aber wir ___ danach spielen.",a:["mussten...durften","m√ºssen...d√ºrfen","m√ºssten...d√ºrften","gemusst...gedurft"],c:0},
                {cat:"H√∂flichkeit",q:"___ Sie so freundlich sein, mir zu helfen?",a:["W√ºrden","Werden","Wollen","K√∂nnen"],c:0},
                {cat:"H√∂flichkeit",q:"Ich ___ Sie bitten, leiser zu sein.",a:["m√∂chte","will","muss","soll"],c:0},
                {cat:"Bedauern",q:"Ich bedaure, ___ ich nicht dabei sein konnte.",a:["dass","weil","wenn","als"],c:0},
                {cat:"Bedauern",q:"Es tut mir leid, ___ das passiert ist.",a:["dass","weil","wenn","als"],c:0},
                {cat:"Konjunktiv II",q:"Wenn ich mehr Zeit ___, w√ºrde ich mehr lernen.",a:["h√§tte","habe","hatte","haben"],c:0},
                {cat:"Konjunktiv II",q:"Wenn er hier ___, w√ºrde er helfen.",a:["w√§re","ist","war","sein"],c:0},
                {cat:"Modalverben Mix",q:"Er ___ den Bericht bis morgen fertig haben.",a:["muss","soll","kann","darf"],c:0},
                {cat:"Modalverben Mix",q:"Sie ___ fr√ºher gehen, wenn Sie m√∂chten.",a:["d√ºrfen","m√ºssen","sollen","k√∂nnen"],c:0},
                {cat:"Satzbau",q:"Nachdem er die E-Mail ___ hat, ruft er an.",a:["geschrieben","schreiben","schreibt","schrieb"],c:0}
            ]
        };
        
        const teamEmoji = {mond:"üåô",sonne:"‚òÄÔ∏è",stern:"‚≠ê",ozean:"üåä"};
        
        let gameCode, playerId, playerName, playerTeam, isHost = false, difficulty = 'einfach';
        let currentQ = -1, answered = false, timerInt = null, evaluating = false;
        let gameRef, playersRef, scoresRef, allPlayers = [], teamScores = {mond:0,sonne:0,stern:0,ozean:0};
        let gameQuestions = [];
        
        function hideStatus() {
            const st = document.getElementById("answer-status");
            st.className = "answer-status hidden";
            st.textContent = "";
        }
        
        db.ref(".info/connected").on("value", s => {
            const el = document.getElementById("connection-status");
            el.textContent = s.val() ? "üü¢ Online" : "üî¥ Offline";
            el.className = "connection-status " + (s.val() ? "connected" : "disconnected");
        });
        
        document.querySelectorAll('.diff-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                difficulty = btn.dataset.diff;
            };
        });
        document.querySelector('.diff-btn.einfach').classList.add('selected');
        
        function genCode() {
            const c = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
            return Array(4).fill(0).map(() => c[Math.floor(Math.random() * c.length)]).join('');
        }
        
        function showError(m) {
            document.getElementById("error-msg").textContent = m;
            setTimeout(() => document.getElementById("error-msg").textContent = "", 3000);
        }
        
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
        
        function shuffle(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }
        
        document.getElementById("create-btn").onclick = function() {
            playerName = document.getElementById("player-name").value.trim();
            playerTeam = document.getElementById("team-select").value;
            if (!playerName) { showError("Name eingeben!"); return; }
            if (!playerTeam) { showError("Team w√§hlen!"); return; }
            
            gameCode = genCode();
            playerId = "host_" + Date.now();
            isHost = true;
            gameQuestions = shuffle([...questions[difficulty]]).slice(0, 25);
            
            gameRef = db.ref("teambattle2/" + gameCode);
            playersRef = db.ref("teambattle2/" + gameCode + "/players");
            scoresRef = db.ref("teambattle2/" + gameCode + "/scores");
            
            gameRef.remove().then(() => {
                return gameRef.set({
                    status: "lobby",
                    difficulty: difficulty,
                    currentQuestion: -1,
                    questionStart: null,
                    questions: gameQuestions,
                    host: playerId
                });
            }).then(() => scoresRef.set({mond:0,sonne:0,stern:0,ozean:0}))
            .then(() => {
                return playersRef.child(playerId).set({
                    name: playerName,
                    team: playerTeam,
                    isHost: true,
                    answered: false
                });
            }).then(() => {
                playersRef.child(playerId).onDisconnect().remove();
                showLobby();
                setupListeners();
            });
        };
        
        document.getElementById("join-btn").onclick = function() {
            playerName = document.getElementById("player-name").value.trim();
            playerTeam = document.getElementById("team-select").value;
            gameCode = document.getElementById("game-code").value.trim().toUpperCase();
            
            if (!playerName) { showError("Name eingeben!"); return; }
            if (!playerTeam) { showError("Team w√§hlen!"); return; }
            if (!gameCode || gameCode.length !== 4) { showError("4-stelliger Code!"); return; }
            
            playerId = "p_" + Date.now() + "_" + Math.random().toString(36).substr(2, 4);
            isHost = false;
            
            gameRef = db.ref("teambattle2/" + gameCode);
            playersRef = db.ref("teambattle2/" + gameCode + "/players");
            scoresRef = db.ref("teambattle2/" + gameCode + "/scores");
            
            gameRef.once("value").then(s => {
                if (!s.exists()) { showError("Spiel nicht gefunden!"); return Promise.reject(); }
                if (s.val().status !== "lobby") { showError("Spiel l√§uft bereits!"); return Promise.reject(); }
                
                difficulty = s.val().difficulty;
                gameQuestions = s.val().questions;
                
                return playersRef.child(playerId).set({
                    name: playerName,
                    team: playerTeam,
                    isHost: false,
                    answered: false
                });
            }).then(() => {
                playersRef.child(playerId).onDisconnect().remove();
                showLobby();
                setupListeners();
            }).catch(() => {});
        };
        
        document.getElementById("game-code").onkeypress = e => { if (e.key === "Enter") document.getElementById("join-btn").click(); };
        
        function showLobby() {
            showScreen("lobby-screen");
            document.getElementById("lobby-code").textContent = gameCode;
            
            const badge = document.getElementById("diff-badge");
            badge.textContent = difficulty.charAt(0).toUpperCase() + difficulty.slice(1);
            badge.className = "diff-badge " + difficulty;
            
            document.getElementById("host-controls").style.display = isHost ? "block" : "none";
            document.getElementById("player-controls").style.display = isHost ? "none" : "block";
        }
        
        function setupListeners() {
            playersRef.on("value", snap => {
                const players = [];
                snap.forEach(c => {
                    const d = c.val();
                    if (d && d.name) players.push({ id: c.key, ...d });
                });
                allPlayers = players;
                updatePlayers(players);
                checkAllAnswered();
            });
            
            scoresRef.on("value", snap => {
                const s = snap.val();
                if (s) { teamScores = s; updateScores(); }
            });
            
            gameRef.on("value", snap => {
                const game = snap.val();
                if (!game) { backToHome(); return; }
                
                if (game.status === "playing") {
                    showScreen("game-screen");
                    if (game.currentQuestion !== currentQ) {
                        hideStatus();
                        document.getElementById("answers").innerHTML = "";
                        currentQ = game.currentQuestion;
                        evaluating = false;
                        showQuestion(game.questionStart);
                    }
                } else if (game.status === "finished") {
                    endGame();
                }
            });
        }
        
        function updatePlayers(players) {
            ["mond","sonne","stern","ozean"].forEach(t => {
                document.getElementById("team-" + t).innerHTML = 
                    players.filter(p => p.team === t).map(p => 
                        `<div class="team-player">${p.name}${p.isHost ? ' üëë' : ''}</div>`
                    ).join("") || '<span style="color:#666;font-size:0.8em">Leer</span>';
            });
            document.getElementById("start-btn").disabled = players.filter(p => !p.isHost).length === 0;
        }
        
        function updateScores() {
            ["mond","sonne","stern","ozean"].forEach(t => {
                document.getElementById("score-" + t).textContent = teamScores[t] || 0;
            });
        }
        
        function checkAllAnswered() {
            if (evaluating || currentQ < 0) return;
            if (allPlayers.length > 0 && allPlayers.every(p => p.answered)) {
                evaluating = true;
                if (timerInt) clearInterval(timerInt);
                evaluate();
            }
        }
        
        document.getElementById("start-btn").onclick = function() {
            if (!isHost) return;
            playersRef.once("value", s => {
                s.forEach(c => playersRef.child(c.key).update({ answered: false }));
                gameRef.update({ status: "playing", currentQuestion: 0, questionStart: Date.now() });
            });
        };
        
        document.getElementById("reset-btn").onclick = function() {
            if (!confirm("Zur√ºcksetzen?")) return;
            gameRef.update({ status: "lobby", currentQuestion: -1, questionStart: null });
            scoresRef.set({mond:0,sonne:0,stern:0,ozean:0});
            playersRef.once("value", s => s.forEach(c => playersRef.child(c.key).update({ answered: false })));
            currentQ = -1;
            evaluating = false;
            hideStatus();
            showScreen("lobby-screen");
        };
        
        function showQuestion(startTime) {
            if (currentQ >= gameQuestions.length) {
                gameRef.update({ status: "finished" });
                return;
            }
            
            answered = false;
            playersRef.child(playerId).update({ answered: false });
            
            const q = gameQuestions[currentQ];
            document.getElementById("question-num").textContent = `${currentQ + 1}/${gameQuestions.length}`;
            document.getElementById("category").textContent = q.cat;
            document.getElementById("question").textContent = q.q;
            document.getElementById("my-team").textContent = teamEmoji[playerTeam];
            
            const idx = [0, 1, 2, 3];
            shuffle(idx);
            
            const ans = document.getElementById("answers");
            ans.innerHTML = "";
            idx.forEach(origIdx => {
                const btn = document.createElement("button");
                btn.className = "answer-btn";
                btn.textContent = q.a[origIdx];
                btn.dataset.origIdx = origIdx;
                btn.onclick = () => selectAnswer(btn, origIdx);
                ans.appendChild(btn);
            });
            
            startTimer(startTime);
        }
        
        function selectAnswer(btn, idx) {
            if (answered) return;
            answered = true;
            
            document.querySelectorAll(".answer-btn").forEach(b => {
                b.disabled = true;
                b.classList.remove("selected");
            });
            btn.classList.add("selected");
            
            playersRef.child(playerId).update({ answered: true, answer: idx });
            
            const st = document.getElementById("answer-status");
            st.className = "answer-status waiting";
            st.textContent = "‚úì Warte auf andere...";
        }
        
        function startTimer(startTime) {
            if (timerInt) clearInterval(timerInt);
            const el = document.getElementById("timer");
            
            function tick() {
                const rem = Math.max(0, 15 - Math.floor((Date.now() - startTime) / 1000));
                el.textContent = rem;
                el.className = "timer" + (rem <= 3 ? " danger" : rem <= 5 ? " warning" : "");
                
                if (rem === 0) {
                    clearInterval(timerInt);
                    if (!evaluating) {
                        evaluating = true;
                        evaluate();
                    }
                }
            }
            tick();
            timerInt = setInterval(tick, 200);
        }
        
        function evaluate() {
            const q = gameQuestions[currentQ];
            const st = document.getElementById("answer-status");
            
            document.querySelectorAll(".answer-btn").forEach(btn => {
                btn.disabled = true;
                if (parseInt(btn.dataset.origIdx) === q.c) btn.classList.add("correct");
            });
            
            // Check my answer
            playersRef.child(playerId).once("value", snap => {
                const data = snap.val();
                if (!data) return;
                
                if (data.answer === undefined) {
                    st.className = "answer-status timeout";
                    st.textContent = "‚è∞ Zeit abgelaufen!";
                } else if (data.answer === q.c) {
                    st.className = "answer-status correct";
                    st.textContent = "‚úÖ Richtig! +1 f√ºr " + teamEmoji[playerTeam];
                    scoresRef.child(playerTeam).transaction(v => (v || 0) + 1);
                } else {
                    document.querySelectorAll(".answer-btn").forEach(btn => {
                        if (parseInt(btn.dataset.origIdx) === data.answer) btn.classList.add("wrong");
                    });
                    st.className = "answer-status wrong";
                    st.textContent = "‚ùå Falsch!";
                }
            });
            
            if (isHost) {
                setTimeout(() => {
                    playersRef.once("value", s => {
                        s.forEach(c => playersRef.child(c.key).update({ answered: false, answer: null }));
                        if (currentQ + 1 >= gameQuestions.length) {
                            gameRef.update({ status: "finished" });
                        } else {
                            gameRef.update({ currentQuestion: currentQ + 1, questionStart: Date.now() });
                        }
                    });
                }, 3000);
            }
        }
        
        function endGame() {
            if (timerInt) clearInterval(timerInt);
            showScreen("gameover-screen");
            
            const sorted = Object.entries(teamScores).sort((a, b) => b[1] - a[1]);
            const winner = sorted[0];
            
            document.getElementById("result-icon").textContent = teamEmoji[winner[0]];
            document.getElementById("result-title").textContent = `${teamEmoji[winner[0]]} gewinnt mit ${winner[1]} Punkten!`;
            
            document.getElementById("final-scores").innerHTML = sorted.map((t, i) => 
                `<div class="final-team ${i === 0 ? 'winner' : ''}">
                    <span>${teamEmoji[t[0]]} ${t[0].charAt(0).toUpperCase() + t[0].slice(1)}</span>
                    <span style="font-size:1.3em;font-weight:700">${t[1]}</span>
                </div>`
            ).join("");
        }
        
        document.getElementById("back-btn").onclick = backToHome;
        
        function backToHome() {
            if (timerInt) clearInterval(timerInt);
            if (gameRef) gameRef.off();
            if (playersRef) {
                playersRef.off();
                if (playerId) playersRef.child(playerId).remove();
            }
            if (scoresRef) scoresRef.off();
            gameCode = playerId = null;
            isHost = false;
            currentQ = -1;
            evaluating = false;
            teamScores = {mond:0,sonne:0,stern:0,ozean:0};
            hideStatus();
            showScreen("login-screen");
            document.getElementById("game-code").value = "";
            document.getElementById("team-select").value = "";
        }
    });
    </script>
    <script data-goatcounter="https://aguitoo.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>
