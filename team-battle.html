<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öîÔ∏è Team Battle - Konnektoren</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: white;
        }
        
        .container { max-width: 900px; margin: 0 auto; padding: 15px; }
        
        h1 {
            text-align: center;
            font-size: 1.5em;
            margin-bottom: 15px;
        }
        
        /* Team Colors */
        .team-mond { background: linear-gradient(135deg, #a29bfe, #6c5ce7); }
        .team-sonne { background: linear-gradient(135deg, #fdcb6e, #f39c12); }
        .team-stern { background: linear-gradient(135deg, #fd79a8, #e84393); }
        .team-ozean { background: linear-gradient(135deg, #74b9ff, #0984e3); }
        
        .border-mond { border-color: #a29bfe !important; }
        .border-sonne { border-color: #fdcb6e !important; }
        .border-stern { border-color: #fd79a8 !important; }
        .border-ozean { border-color: #74b9ff !important; }
        
        /* Login Screen */
        #login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 85vh;
            gap: 15px;
        }
        
        .logo { font-size: 3.5em; animation: pulse 2s infinite; }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        #login-screen h2 { font-size: 1.1em; color: #ffd700; text-align: center; }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            max-width: 320px;
        }
        
        .input-group input {
            font-size: 1.1em;
            padding: 12px 20px;
            border: 2px solid #ffd700;
            border-radius: 25px;
            text-align: center;
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .input-group input::placeholder { color: rgba(255,255,255,0.5); }
        
        .input-group input.code-input {
            font-size: 1.4em;
            letter-spacing: 8px;
            text-transform: uppercase;
        }
        
        /* Team Selection */
        .team-selection {
            width: 100%;
            max-width: 320px;
        }
        
        .team-selection label {
            display: block;
            color: #aaa;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .team-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .team-btn {
            padding: 15px 5px;
            border: 3px solid transparent;
            border-radius: 15px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            color: white;
        }
        
        .team-btn:hover { transform: scale(1.05); }
        .team-btn.selected { border-color: white; box-shadow: 0 0 20px rgba(255,255,255,0.3); }
        
        .team-btn .icon { font-size: 2em; display: block; margin-bottom: 5px; }
        .team-btn .name { font-size: 0.8em; font-weight: bold; }
        
        .btn-primary {
            font-size: 1.1em;
            padding: 15px 40px;
            border: none;
            border-radius: 30px;
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            max-width: 320px;
            margin-top: 10px;
        }
        
        .btn-primary:hover { transform: scale(1.02); }
        
        .btn-secondary {
            font-size: 1em;
            padding: 12px 30px;
            border: 2px solid #ffd700;
            border-radius: 25px;
            background: transparent;
            color: #ffd700;
            cursor: pointer;
            width: 100%;
            max-width: 320px;
        }
        
        .divider {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
            max-width: 320px;
            margin: 5px 0;
        }
        
        .divider::before, .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(255,255,255,0.3);
        }
        
        .divider span { color: #888; font-size: 0.9em; }
        
        /* Lobby */
        #lobby-screen { display: none; }
        
        .lobby-header {
            text-align: center;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            margin-bottom: 20px;
        }
        
        .lobby-code {
            font-size: 2.5em;
            color: #ffd700;
            letter-spacing: 10px;
            margin: 10px 0;
        }
        
        .teams-lobby {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        @media (max-width: 500px) {
            .teams-lobby { grid-template-columns: 1fr; }
        }
        
        .team-box {
            border-radius: 15px;
            overflow: hidden;
        }
        
        .team-box-header {
            padding: 12px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .team-box-players {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            min-height: 80px;
        }
        
        .player-tag {
            display: inline-block;
            padding: 5px 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            margin: 3px;
            font-size: 0.9em;
        }
        
        .player-tag.is-me {
            background: rgba(255,215,0,0.3);
            border: 1px solid rgba(255,215,0,0.5);
        }
        
        .player-tag .remove-btn {
            margin-left: 5px;
            cursor: pointer;
            opacity: 0.7;
        }
        
        .player-tag .remove-btn:hover { opacity: 1; }
        
        .lobby-controls {
            text-align: center;
            margin-top: 20px;
        }
        
        .start-btn {
            font-size: 1.3em;
            padding: 15px 50px;
            border: none;
            border-radius: 30px;
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
            font-weight: bold;
            cursor: pointer;
        }
        
        .start-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .small-btn {
            font-size: 0.85em;
            padding: 8px 15px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 15px;
            background: transparent;
            color: #aaa;
            cursor: pointer;
            margin: 5px;
        }
        
        .small-btn:hover { background: rgba(255,255,255,0.1); }
        .small-btn.danger { border-color: #e74c3c; color: #e74c3c; }
        
        /* Game Screen */
        #game-screen { display: none; }
        
        .scoreboard {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        
        @media (max-width: 500px) {
            .scoreboard { grid-template-columns: repeat(2, 1fr); }
        }
        
        .score-card {
            padding: 10px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid transparent;
        }
        
        .score-card.my-team { border-color: white; }
        
        .score-card .team-icon { font-size: 1.5em; }
        .score-card .team-name { font-size: 0.75em; opacity: 0.9; }
        .score-card .team-score { font-size: 1.8em; font-weight: bold; }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        
        .timer {
            font-size: 2em;
            font-weight: bold;
            color: #00cec9;
        }
        
        .timer.warning { color: #fdcb6e; }
        .timer.danger { color: #e74c3c; animation: pulse 0.5s infinite; }
        
        /* Quiz */
        .quiz-section {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,215,0,0.3);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .category-badge {
            display: inline-block;
            padding: 5px 15px;
            background: rgba(255,215,0,0.2);
            border-radius: 20px;
            font-size: 0.85em;
            color: #ffd700;
            margin-bottom: 12px;
        }
        
        .question {
            font-size: 1.2em;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .answers { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        @media (max-width: 500px) { .answers { grid-template-columns: 1fr; } }
        
        .answer-btn {
            padding: 14px 16px;
            font-size: 1em;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            background: rgba(255,255,255,0.05);
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .answer-btn:hover:not(:disabled) {
            background: rgba(255,215,0,0.2);
            border-color: #ffd700;
        }
        
        .answer-btn.selected {
            background: rgba(100,100,255,0.3);
            border-color: #6c5ce7;
        }
        
        .answer-btn.correct {
            background: rgba(0,184,148,0.6) !important;
            border-color: #00b894 !important;
            box-shadow: 0 0 15px rgba(0,184,148,0.5);
        }
        
        .answer-btn.wrong {
            background: rgba(214,48,49,0.6) !important;
            border-color: #d63031 !important;
        }
        
        .answer-btn:disabled { cursor: not-allowed; opacity: 0.8; }
        
        .answer-status {
            text-align: center;
            padding: 12px;
            margin-top: 15px;
            border-radius: 10px;
            font-weight: bold;
            display: none;
        }
        
        .answer-status.show { display: block; }
        .answer-status.correct { background: rgba(0,184,148,0.3); color: #55efc4; }
        .answer-status.wrong { background: rgba(214,48,49,0.3); color: #ff7675; }
        .answer-status.timeout { background: rgba(253,203,110,0.3); color: #fdcb6e; }
        
        /* Game Over */
        #gameover-screen { display: none; text-align: center; padding: 30px 20px; }
        
        .winner-display {
            margin: 30px 0;
        }
        
        .winner-icon { font-size: 4em; }
        .winner-text { font-size: 1.5em; color: #ffd700; margin: 15px 0; }
        
        .final-scores {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 25px 0;
        }
        
        .final-score-card {
            padding: 15px;
            border-radius: 15px;
            text-align: center;
        }
        
        .final-score-card .place { font-size: 1.5em; }
        .final-score-card .team-name { font-size: 1em; margin: 5px 0; }
        .final-score-card .score { font-size: 2em; font-weight: bold; }
        
        .final-score-card.rank-1 { order: -4; border: 3px solid gold; }
        .final-score-card.rank-2 { order: -3; border: 3px solid silver; }
        .final-score-card.rank-3 { order: -2; border: 3px solid #cd7f32; }
        .final-score-card.rank-4 { order: -1; }
        
        .my-stats {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .my-stats h3 { color: #ffd700; margin-bottom: 15px; }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        /* Connection */
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            background: rgba(0,0,0,0.5);
        }
        
        .connection-status.connected { color: #00b894; }
        .connection-status.disconnected { color: #e74c3c; }
        
        .error-msg {
            color: #e74c3c;
            font-size: 0.9em;
            margin-top: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connection-status">Verbinde...</div>
    
    <div class="container">
        <h1>‚öîÔ∏è Team Battle</h1>
        
        <!-- Login Screen -->
        <div id="login-screen">
            <div class="logo">‚öîÔ∏è</div>
            <h2>Konnektoren: dass, weil, denn, trotzdem, wenn, als</h2>
            
            <div class="input-group">
                <input type="text" id="player-name" placeholder="Dein Name" maxlength="15">
            </div>
            
            <div class="team-selection">
                <label>W√§hle dein Team:</label>
                <div class="team-grid">
                    <div class="team-btn team-mond" data-team="mond">
                        <span class="icon">üåô</span>
                        <span class="name">Mond</span>
                    </div>
                    <div class="team-btn team-sonne" data-team="sonne">
                        <span class="icon">‚òÄÔ∏è</span>
                        <span class="name">Sonne</span>
                    </div>
                    <div class="team-btn team-stern" data-team="stern">
                        <span class="icon">‚≠ê</span>
                        <span class="name">Stern</span>
                    </div>
                    <div class="team-btn team-ozean" data-team="ozean">
                        <span class="icon">üåä</span>
                        <span class="name">Ozean</span>
                    </div>
                </div>
            </div>
            
            <div class="input-group">
                <input type="text" id="game-code" class="code-input" placeholder="CODE" maxlength="4">
            </div>
            
            <button class="btn-primary" id="join-btn">üö™ Beitreten</button>
            
            <div class="divider"><span>oder</span></div>
            
            <button class="btn-secondary" id="create-btn">üëë Neues Spiel erstellen</button>
            
            <div class="error-msg" id="error-msg"></div>
        </div>
        
        <!-- Lobby Screen -->
        <div id="lobby-screen">
            <div class="lobby-header">
                <h2>‚è≥ Warteraum</h2>
                <div class="lobby-code" id="lobby-code">CODE</div>
                <p style="color: #888; font-size: 0.9em;">Teile diesen Code mit den Teams</p>
            </div>
            
            <div class="teams-lobby">
                <div class="team-box">
                    <div class="team-box-header team-mond">üåô Mond</div>
                    <div class="team-box-players" id="players-mond"></div>
                </div>
                <div class="team-box">
                    <div class="team-box-header team-sonne">‚òÄÔ∏è Sonne</div>
                    <div class="team-box-players" id="players-sonne"></div>
                </div>
                <div class="team-box">
                    <div class="team-box-header team-stern">‚≠ê Stern</div>
                    <div class="team-box-players" id="players-stern"></div>
                </div>
                <div class="team-box">
                    <div class="team-box-header team-ozean">üåä Ozean</div>
                    <div class="team-box-players" id="players-ozean"></div>
                </div>
            </div>
            
            <div class="lobby-controls" id="host-controls">
                <button class="start-btn" id="start-btn" disabled>‚ñ∂Ô∏è SPIEL STARTEN</button>
                <p style="color: #00b894; font-size: 0.85em; margin-top: 10px;">üëë Du bist der Spielleiter</p>
                <div>
                    <button class="small-btn danger" id="clear-btn">üóëÔ∏è Alle entfernen</button>
                    <button class="small-btn danger" id="reset-btn">üîÑ Zur√ºcksetzen</button>
                </div>
            </div>
            
            <div class="lobby-controls" id="player-controls" style="display:none;">
                <p style="color: #fdcb6e; font-size: 1.1em;">‚è≥ Warte auf Spielleiter...</p>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="game-screen">
            <div class="scoreboard" id="scoreboard">
                <div class="score-card team-mond" data-team="mond">
                    <div class="team-icon">üåô</div>
                    <div class="team-name">Mond</div>
                    <div class="team-score" id="score-mond">0</div>
                </div>
                <div class="score-card team-sonne" data-team="sonne">
                    <div class="team-icon">‚òÄÔ∏è</div>
                    <div class="team-name">Sonne</div>
                    <div class="team-score" id="score-sonne">0</div>
                </div>
                <div class="score-card team-stern" data-team="stern">
                    <div class="team-icon">‚≠ê</div>
                    <div class="team-name">Stern</div>
                    <div class="team-score" id="score-stern">0</div>
                </div>
                <div class="score-card team-ozean" data-team="ozean">
                    <div class="team-icon">üåä</div>
                    <div class="team-name">Ozean</div>
                    <div class="team-score" id="score-ozean">0</div>
                </div>
            </div>
            
            <div class="game-info">
                <span id="question-num">Frage 1/30</span>
                <div class="timer" id="timer">15</div>
                <span id="my-points">+0 Punkte</span>
            </div>
            
            <div class="quiz-section">
                <div class="category-badge" id="category">Konnektoren</div>
                <div class="question" id="question"></div>
                <div class="answers" id="answers"></div>
                <div class="answer-status" id="answer-status"></div>
            </div>
        </div>
        
        <!-- Game Over -->
        <div id="gameover-screen">
            <div class="winner-display">
                <div class="winner-icon" id="winner-icon">üèÜ</div>
                <div class="winner-text" id="winner-text">Team Sonne gewinnt!</div>
            </div>
            
            <div class="final-scores" id="final-scores"></div>
            
            <div class="my-stats">
                <h3>Deine Statistik</h3>
                <div class="stat-row"><span>Richtige Antworten</span><span id="stat-correct">0</span></div>
                <div class="stat-row"><span>Punkte beigetragen</span><span id="stat-points">0</span></div>
            </div>
            
            <button class="btn-primary" id="back-btn">üè† Zur√ºck zum Start</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        
        if (typeof firebase === 'undefined') {
            document.getElementById('error-msg').textContent = "Firebase konnte nicht geladen werden.";
            return;
        }
        
        firebase.initializeApp({
            apiKey: "AIzaSyBDChXlm34Kr7Gg0Dw458GiiwoLnWJAnxM",
            authDomain: "lern-deutsch-arash.firebaseapp.com",
            databaseURL: "https://lern-deutsch-arash-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "lern-deutsch-arash",
            storageBucket: "lern-deutsch-arash.firebasestorage.app",
            messagingSenderId: "845503292114",
            appId: "1:845503292114:web:f76ab5fcde1e978d00c30b"
        });
        
        const db = firebase.database();
        
        // Teams
        const teams = {
            mond: { icon: 'üåô', name: 'Mond' },
            sonne: { icon: '‚òÄÔ∏è', name: 'Sonne' },
            stern: { icon: '‚≠ê', name: 'Stern' },
            ozean: { icon: 'üåä', name: 'Ozean' }
        };
        
        // 30 Fragen zu Konnektoren
        const questions = [
            // DASS (5)
            { cat: "dass", q: "Ich hoffe, ___ du morgen kommst.", a: ["dass", "weil", "denn", "wenn"], c: 0 },
            { cat: "dass", q: "Er sagt, ___ er keine Zeit hat.", a: ["dass", "weil", "obwohl", "denn"], c: 0 },
            { cat: "dass", q: "Ich wei√ü, ___ das schwer ist.", a: ["dass", "wenn", "als", "denn"], c: 0 },
            { cat: "dass", q: "Es ist wichtig, ___ du p√ºnktlich bist.", a: ["dass", "weil", "denn", "trotzdem"], c: 0 },
            { cat: "dass", q: "Ich glaube, ___ er recht hat.", a: ["dass", "wenn", "weil", "als"], c: 0 },
            
            // WEIL (5)
            { cat: "weil", q: "Ich bleibe zu Hause, ___ ich krank bin.", a: ["weil", "dass", "denn", "trotzdem"], c: 0 },
            { cat: "weil", q: "Sie ist m√ºde, ___ sie lange gearbeitet hat.", a: ["weil", "dass", "wenn", "als"], c: 0 },
            { cat: "weil", q: "Er lernt Deutsch, ___ er in Deutschland arbeiten will.", a: ["weil", "denn", "dass", "trotzdem"], c: 0 },
            { cat: "weil", q: "Ich kann nicht kommen, ___ ich einen Termin habe.", a: ["weil", "dass", "denn", "wenn"], c: 0 },
            { cat: "weil", q: "Sie weint, ___ sie traurig ist.", a: ["weil", "dass", "trotzdem", "als"], c: 0 },
            
            // DENN (5)
            { cat: "denn", q: "Ich gehe nicht raus, ___ es regnet.", a: ["denn", "weil", "dass", "trotzdem"], c: 0 },
            { cat: "denn", q: "Er isst nichts, ___ er hat keinen Hunger.", a: ["denn", "weil", "dass", "wenn"], c: 0 },
            { cat: "denn", q: "Sie kommt sp√§ter, ___ sie muss noch arbeiten.", a: ["denn", "weil", "dass", "als"], c: 0 },
            { cat: "denn", q: "Ich helfe dir, ___ du bist mein Freund.", a: ["denn", "weil", "dass", "trotzdem"], c: 0 },
            { cat: "denn", q: "Wir fahren mit dem Bus, ___ das Auto ist kaputt.", a: ["denn", "weil", "dass", "wenn"], c: 0 },
            
            // TROTZDEM (5)
            { cat: "trotzdem", q: "Es regnet. ___ gehe ich spazieren.", a: ["Trotzdem", "Weil", "Dass", "Denn"], c: 0 },
            { cat: "trotzdem", q: "Er ist m√ºde. ___ arbeitet er weiter.", a: ["Trotzdem", "Weil", "Wenn", "Denn"], c: 0 },
            { cat: "trotzdem", q: "Ich habe Kopfschmerzen. ___ gehe ich zur Arbeit.", a: ["Trotzdem", "Dass", "Weil", "Als"], c: 0 },
            { cat: "trotzdem", q: "Das Essen ist teuer. ___ kaufe ich es.", a: ["Trotzdem", "Denn", "Weil", "Wenn"], c: 0 },
            { cat: "trotzdem", q: "Sie hat wenig Zeit. ___ hilft sie mir.", a: ["Trotzdem", "Dass", "Weil", "Denn"], c: 0 },
            
            // WENN (5)
            { cat: "wenn", q: "___ du kommst, freue ich mich.", a: ["Wenn", "Als", "Dass", "Weil"], c: 0 },
            { cat: "wenn", q: "___ es regnet, bleibe ich zu Hause.", a: ["Wenn", "Als", "Denn", "Trotzdem"], c: 0 },
            { cat: "wenn", q: "Ich rufe dich an, ___ ich fertig bin.", a: ["wenn", "als", "dass", "denn"], c: 0 },
            { cat: "wenn", q: "___ ich Zeit habe, lese ich gern.", a: ["Wenn", "Als", "Weil", "Dass"], c: 0 },
            { cat: "wenn", q: "Er wird gl√ºcklich sein, ___ er das h√∂rt.", a: ["wenn", "als", "denn", "trotzdem"], c: 0 },
            
            // ALS (5)
            { cat: "als", q: "___ ich ein Kind war, wohnte ich in Berlin.", a: ["Als", "Wenn", "Weil", "Dass"], c: 0 },
            { cat: "als", q: "___ er ankam, war es schon dunkel.", a: ["Als", "Wenn", "Denn", "Trotzdem"], c: 0 },
            { cat: "als", q: "Ich war traurig, ___ du gegangen bist.", a: ["als", "wenn", "dass", "weil"], c: 0 },
            { cat: "als", q: "___ ich jung war, spielte ich Fu√üball.", a: ["Als", "Wenn", "Weil", "Denn"], c: 0 },
            { cat: "als", q: "Sie hat geweint, ___ sie den Film gesehen hat.", a: ["als", "wenn", "dass", "trotzdem"], c: 0 }
        ];
        
        // State
        let gameCode = null;
        let playerId = null;
        let playerName = null;
        let playerTeam = null;
        let isHost = false;
        let currentQ = -1;
        let answered = false;
        let selected = null;
        let myCorrect = 0;
        let myPoints = 0;
        let timer = null;
        let gameRef = null;
        let playersRef = null;
        let scoresRef = null;
        
        // Connection
        db.ref(".info/connected").on("value", snap => {
            const el = document.getElementById("connection-status");
            el.textContent = snap.val() ? "üü¢ Online" : "üî¥ Offline";
            el.className = "connection-status " + (snap.val() ? "connected" : "disconnected");
        });
        
        // Team selection
        document.querySelectorAll(".team-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                document.querySelectorAll(".team-btn").forEach(b => b.classList.remove("selected"));
                btn.classList.add("selected");
                playerTeam = btn.dataset.team;
            });
        });
        
        // Generate code
        function generateCode() {
            const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
            let code = "";
            for (let i = 0; i < 4; i++) code += chars[Math.floor(Math.random() * chars.length)];
            return code;
        }
        
        // Event listeners
        document.getElementById("create-btn").addEventListener("click", createGame);
        document.getElementById("join-btn").addEventListener("click", joinGame);
        document.getElementById("start-btn").addEventListener("click", startGame);
        document.getElementById("clear-btn").addEventListener("click", clearPlayers);
        document.getElementById("reset-btn").addEventListener("click", resetGame);
        document.getElementById("back-btn").addEventListener("click", backToHome);
        
        function showError(msg) {
            document.getElementById("error-msg").textContent = msg;
            setTimeout(() => document.getElementById("error-msg").textContent = "", 3000);
        }
        
        function createGame() {
            playerName = document.getElementById("player-name").value.trim();
            if (!playerName) { showError("Bitte Name eingeben!"); return; }
            if (!playerTeam) { showError("Bitte Team w√§hlen!"); return; }
            
            gameCode = generateCode();
            playerId = "host_" + Date.now();
            isHost = true;
            
            gameRef = db.ref("teambattle/" + gameCode);
            playersRef = db.ref("teambattle/" + gameCode + "/players");
            scoresRef = db.ref("teambattle/" + gameCode + "/scores");
            
            gameRef.remove().then(() => {
                return gameRef.set({
                    status: "lobby",
                    currentQuestion: -1,
                    questionStart: null,
                    host: playerId,
                    scores: { mond: 0, sonne: 0, stern: 0, ozean: 0 }
                });
            }).then(() => {
                return playersRef.child(playerId).set({
                    name: playerName,
                    team: playerTeam,
                    isHost: true
                });
            }).then(() => {
                playersRef.child(playerId).onDisconnect().remove();
                showLobby();
                setupListeners();
            }).catch(err => showError("Fehler: " + err.message));
        }
        
        function joinGame() {
            playerName = document.getElementById("player-name").value.trim();
            gameCode = document.getElementById("game-code").value.trim().toUpperCase();
            
            if (!playerName) { showError("Bitte Name eingeben!"); return; }
            if (!playerTeam) { showError("Bitte Team w√§hlen!"); return; }
            if (!gameCode || gameCode.length !== 4) { showError("Bitte 4-stelligen Code!"); return; }
            
            playerId = "p_" + Date.now() + "_" + Math.random().toString(36).substr(2,4);
            isHost = false;
            
            gameRef = db.ref("teambattle/" + gameCode);
            playersRef = db.ref("teambattle/" + gameCode + "/players");
            scoresRef = db.ref("teambattle/" + gameCode + "/scores");
            
            gameRef.once("value").then(snap => {
                if (!snap.exists()) { showError("Spiel nicht gefunden!"); return; }
                if (snap.val().status !== "lobby") { showError("Spiel l√§uft bereits!"); return; }
                
                return playersRef.child(playerId).set({
                    name: playerName,
                    team: playerTeam,
                    isHost: false
                });
            }).then(() => {
                if (!playerId) return;
                playersRef.child(playerId).onDisconnect().remove();
                showLobby();
                setupListeners();
            }).catch(err => showError("Fehler: " + err.message));
        }
        
        function showLobby() {
            document.getElementById("login-screen").style.display = "none";
            document.getElementById("lobby-screen").style.display = "block";
            document.getElementById("lobby-code").textContent = gameCode;
            
            document.getElementById("host-controls").style.display = isHost ? "block" : "none";
            document.getElementById("player-controls").style.display = isHost ? "none" : "block";
        }
        
        function setupListeners() {
            playersRef.on("value", snap => {
                const players = { mond: [], sonne: [], stern: [], ozean: [] };
                let total = 0;
                
                snap.forEach(child => {
                    const p = child.val();
                    if (p && p.name && p.team) {
                        players[p.team].push({ id: child.key, ...p });
                        total++;
                    }
                });
                
                updateLobbyPlayers(players);
                document.getElementById("start-btn").disabled = total < 2;
            });
            
            gameRef.on("value", snap => {
                const game = snap.val();
                if (!game) { backToHome(); return; }
                
                if (game.status === "playing") {
                    document.getElementById("lobby-screen").style.display = "none";
                    document.getElementById("game-screen").style.display = "block";
                    
                    // Highlight my team
                    document.querySelectorAll(".score-card").forEach(card => {
                        card.classList.toggle("my-team", card.dataset.team === playerTeam);
                    });
                    
                    if (game.currentQuestion !== currentQ) {
                        currentQ = game.currentQuestion;
                        showQuestion(game.questionStart);
                    }
                    
                    // Update scores
                    if (game.scores) {
                        Object.keys(game.scores).forEach(team => {
                            document.getElementById("score-" + team).textContent = game.scores[team];
                        });
                    }
                } else if (game.status === "finished") {
                    endGame(game.scores);
                }
            });
        }
        
        function updateLobbyPlayers(players) {
            Object.keys(players).forEach(team => {
                const container = document.getElementById("players-" + team);
                if (players[team].length === 0) {
                    container.innerHTML = '<span style="color:#666;font-size:0.85em">Noch niemand</span>';
                } else {
                    container.innerHTML = players[team].map(p => `
                        <span class="player-tag ${p.id === playerId ? 'is-me' : ''}">
                            ${p.name} ${p.isHost ? 'üëë' : ''}
                            ${isHost && !p.isHost ? `<span class="remove-btn" data-id="${p.id}">‚úï</span>` : ''}
                        </span>
                    `).join("");
                    
                    container.querySelectorAll(".remove-btn").forEach(btn => {
                        btn.addEventListener("click", () => playersRef.child(btn.dataset.id).remove());
                    });
                }
            });
        }
        
        function clearPlayers() {
            if (!confirm("Alle Spieler entfernen (au√üer dir)?")) return;
            playersRef.once("value", snap => {
                snap.forEach(child => {
                    if (child.key !== playerId) playersRef.child(child.key).remove();
                });
            });
        }
        
        function resetGame() {
            if (!confirm("Spiel zur√ºcksetzen?")) return;
            gameRef.update({
                status: "lobby",
                currentQuestion: -1,
                questionStart: null,
                scores: { mond: 0, sonne: 0, stern: 0, ozean: 0 }
            });
            currentQ = -1;
            myCorrect = 0;
            myPoints = 0;
            document.getElementById("game-screen").style.display = "none";
            document.getElementById("gameover-screen").style.display = "none";
            document.getElementById("lobby-screen").style.display = "block";
        }
        
        function startGame() {
            if (!isHost) return;
            gameRef.update({
                status: "playing",
                currentQuestion: 0,
                questionStart: Date.now(),
                scores: { mond: 0, sonne: 0, stern: 0, ozean: 0 }
            });
        }
        
        function showQuestion(startTime) {
            if (currentQ >= questions.length) {
                gameRef.once("value", snap => {
                    gameRef.update({ status: "finished" });
                });
                return;
            }
            
            answered = false;
            selected = null;
            
            const q = questions[currentQ];
            document.getElementById("question-num").textContent = `Frage ${currentQ + 1}/${questions.length}`;
            document.getElementById("category").textContent = q.cat;
            document.getElementById("question").textContent = q.q;
            document.getElementById("my-points").textContent = `+${myPoints} Punkte`;
            
            // Shuffle answers
            const shuffled = q.a.map((text, origIdx) => ({ text, origIdx }));
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            
            const answersEl = document.getElementById("answers");
            answersEl.innerHTML = "";
            
            shuffled.forEach((item, i) => {
                const btn = document.createElement("button");
                btn.className = "answer-btn";
                btn.textContent = item.text;
                btn.dataset.origIdx = item.origIdx;
                btn.addEventListener("click", () => selectAnswer(btn, item.origIdx));
                answersEl.appendChild(btn);
            });
            
            document.getElementById("answer-status").className = "answer-status";
            startTimer(startTime);
        }
        
        function selectAnswer(btn, idx) {
            if (answered) return;
            answered = true;
            selected = idx;
            
            document.querySelectorAll(".answer-btn").forEach(b => {
                b.disabled = true;
                b.classList.remove("selected");
            });
            btn.classList.add("selected");
        }
        
        function startTimer(startTime) {
            if (timer) clearInterval(timer);
            const timerEl = document.getElementById("timer");
            const duration = 15;
            
            function tick() {
                const remaining = Math.max(0, duration - Math.floor((Date.now() - startTime) / 1000));
                timerEl.textContent = remaining;
                timerEl.className = "timer" + (remaining <= 3 ? " danger" : remaining <= 5 ? " warning" : "");
                
                if (remaining === 0) {
                    clearInterval(timer);
                    evaluate();
                }
            }
            
            tick();
            timer = setInterval(tick, 200);
        }
        
        function evaluate() {
            const q = questions[currentQ];
            const status = document.getElementById("answer-status");
            
            document.querySelectorAll(".answer-btn").forEach(btn => {
                btn.disabled = true;
                if (parseInt(btn.dataset.origIdx) === q.c) btn.classList.add("correct");
            });
            
            if (selected === q.c) {
                myCorrect++;
                myPoints += 10;
                document.getElementById("my-points").textContent = `+${myPoints} Punkte`;
                
                // Add points to team
                scoresRef.child(playerTeam).transaction(current => (current || 0) + 10);
                
                status.className = "answer-status correct show";
                status.textContent = "‚úÖ +10 Punkte f√ºr Team " + teams[playerTeam].name + "!";
            } else {
                if (selected !== null) {
                    document.querySelectorAll(".answer-btn").forEach(btn => {
                        if (parseInt(btn.dataset.origIdx) === selected) btn.classList.add("wrong");
                    });
                }
                status.className = "answer-status " + (selected === null ? "timeout" : "wrong") + " show";
                status.textContent = selected === null ? "‚è∞ Zeit abgelaufen!" : "‚ùå Falsch!";
            }
            
            // Next question
            if (isHost) {
                setTimeout(() => {
                    const next = currentQ + 1;
                    if (next >= questions.length) {
                        gameRef.update({ status: "finished" });
                    } else {
                        gameRef.update({ currentQuestion: next, questionStart: Date.now() });
                    }
                }, 3000);
            }
        }
        
        function endGame(scores) {
            if (timer) clearInterval(timer);
            
            document.getElementById("game-screen").style.display = "none";
            document.getElementById("gameover-screen").style.display = "block";
            
            // Sort teams by score
            const sorted = Object.entries(scores).sort((a, b) => b[1] - a[1]);
            const winner = sorted[0];
            
            document.getElementById("winner-icon").textContent = teams[winner[0]].icon;
            document.getElementById("winner-text").textContent = `Team ${teams[winner[0]].name} gewinnt!`;
            
            const finalEl = document.getElementById("final-scores");
            finalEl.innerHTML = sorted.map(([team, score], idx) => `
                <div class="final-score-card team-${team} rank-${idx + 1}">
                    <div class="place">${['ü•á', 'ü•à', 'ü•â', '4.'][idx]}</div>
                    <div class="team-name">${teams[team].icon} ${teams[team].name}</div>
                    <div class="score">${score}</div>
                </div>
            `).join("");
            
            document.getElementById("stat-correct").textContent = myCorrect;
            document.getElementById("stat-points").textContent = myPoints;
        }
        
        function backToHome() {
            if (timer) clearInterval(timer);
            if (gameRef) gameRef.off();
            if (playersRef) {
                playersRef.off();
                if (playerId) playersRef.child(playerId).remove();
            }
            
            gameCode = playerId = playerTeam = null;
            isHost = false;
            currentQ = -1;
            myCorrect = myPoints = 0;
            
            document.querySelectorAll(".team-btn").forEach(b => b.classList.remove("selected"));
            document.getElementById("game-code").value = "";
            
            document.getElementById("lobby-screen").style.display = "none";
            document.getElementById("game-screen").style.display = "none";
            document.getElementById("gameover-screen").style.display = "none";
            document.getElementById("login-screen").style.display = "flex";
        }
    });
    </script>
    
    <script data-goatcounter="https://aguitoo.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>
